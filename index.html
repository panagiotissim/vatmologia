<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#22c55e" />
<title>Î‘Î¸Î»Î·Ï„Î¹ÎºÎ® Î‘Î»Î¹ÎµÎ¯Î± â€” ÎšÎ»Î®ÏÏ‰ÏƒÎ· & Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± (Mobile + PWA)</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<!-- Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎµÏ‚ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>
<style>
  :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --line:#1f2937; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(120deg,#0b1023,#111827);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{padding:16px;border-bottom:1px solid var(--line);background:rgba(15,23,42,.9);backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:18px}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  nav button{padding:10px 14px;border-radius:12px;border:1px solid #273244;background:#0b1220;color:var(--ink);cursor:pointer;min-height:44px;font-size:16px}
  nav button.active{background:var(--accent);color:#07120c;border-color:transparent;font-weight:700}
  .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px}
  .row{display:flex;gap:8px}
  .row>*{flex:1}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid #273244;background:#0b1220;color:var(--ink);min-height:44px;font-size:16px}
  button.primary{background:var(--accent);border-color:transparent;color:#0b1020;font-weight:700;cursor:pointer}
  button.warn{background:var(--warn);color:#091015;border-color:transparent;cursor:pointer}
  button.ghost{background:#0b1220;cursor:pointer}
  button.danger{background:var(--danger);border-color:transparent;color:#fff;cursor:pointer}
  .muted{color:var(--muted)} .small{font-size:12px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #223255;font-size:12px;margin:2px 4px 0 0}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;white-space:nowrap}
  th{font-size:12px;color:var(--muted);font-weight:600}
  /* Scrollable tables on mobile */
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .table-wrap table{min-width:720px}
  /* Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· Î¼ÏŒÎ½Î¿ ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚ */
  @media print {
    body.print-draw .card:not(.draw-section){ display:none !important; }
    body.print-draw header, body.print-draw nav{display:none}
    body.print-draw .draw-section{ border:none; box-shadow:none }
  }
  /* Mobile stacks */
  @media (max-width:900px){ .row{flex-direction:column} }
</style>
</head>
<body>
<header>
  <h1>ğŸ£ Î‘Î¸Î»Î·Ï„Î¹ÎºÎ® Î‘Î»Î¹ÎµÎ¯Î± â€” ÎšÎ»Î®ÏÏ‰ÏƒÎ· & Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±</h1>
  <nav id="topNav">
    <button data-page="p-participants" class="active">Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Î¿Î½Ï„ÎµÏ‚</button>
    <button data-page="p-draw">Î—Î¼Î­ÏÎµÏ‚ & ÎšÎ»Î®ÏÏ‰ÏƒÎ·</button>
    <button data-page="p-entry">ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î®</button>
    <button data-page="p-scores">Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯ÎµÏ‚ & Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚</button>
    <button data-page="p-settings">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
  </nav>
</header>

<div class="wrap">
  <!-- Î£Î•Î›Î™Î”Î‘: Î£Î¥ÎœÎœÎ•Î¤Î•Î§ÎŸÎÎ¤Î•Î£ -->
  <section id="p-participants" class="page">
    <div class="card">
      <h2>Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Î¿Î½Ï„ÎµÏ‚ (Î£ÏÎ»Î»Î¿Î³Î¿Ï‚)</h2>
      <div class="row">
        <div><label>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</label><input id="athleteName" placeholder="Ï€.Ï‡. ÎÎ¯ÎºÎ¿Ï‚ Î Î±Ï€Î±Î´ÏŒÏ€Î¿Ï…Î»Î¿Ï‚"></div>
        <div><label>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</label><input id="club" placeholder="Ï€.Ï‡. Î.ÎŸ. Î ÏŒÎ»Î·Ï‚"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="primary" id="addAthleteBtn">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
        <button class="ghost" id="addBulkBtn">ğŸ“¥ ÎœÎ±Î¶Î¹ÎºÎ® ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®</button>
        <input id="excelInput" type="file" accept=".xlsx,.xls,.csv" style="display:none">
        <button class="warn" id="excelBtn">ğŸ—‚ï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Î±Ï€ÏŒ Excel/CSV</button>
      </div>
      <div class="small muted" style="margin-top:4px">CSV: <code>ÎŒÎ½Î¿Î¼Î±, Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</code></div>
    </div>
    <div class="card">
      <div class="table-wrap" id="athletesTableWrap"></div>
    </div>

    <div class="card">
      <h2>ÎŸÎ¼Î±Î´Î¹ÎºÏŒ â€” ÎšÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î± Î±Î½Î¬ Î£ÏÎ»Î»Î¿Î³Î¿</h2>
      <div id="teamsWrap" class="small"></div>
      <div class="small muted">NS/DQ ÏƒÏ„Î· 5Î¬Î´Î± â†’ Î¸Î­ÏƒÎ· MAX+1 Î³Î¹Î± Ï„Î· Î¼Î­ÏÎ± (MAX = Î¼Î­Î³ÎµÎ¸Î¿Ï‚ Ï„Î¿Î¼Î­Î±).</div>
    </div>
  </section>

  <!-- Î£Î•Î›Î™Î”Î‘: Î—ÎœÎ•Î¡Î•Î£ & ÎšÎ›Î—Î¡Î©Î£Î— -->
  <section id="p-draw" class="page" style="display:none">
    <div class="card">
      <h2>Î—Î¼Î­ÏÎµÏ‚ / Î“ÏÏÎ¿Î¹</h2>
      <div class="row">
        <div><label>ÎŒÎ½Î¿Î¼Î± Î·Î¼Î­ÏÎ±Ï‚</label><input id="dayName" placeholder="1Î· Î—Î¼Î­ÏÎ±"></div>
        <div><label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label><input id="dayDate" type="date"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="primary" id="addDayBtn">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î·Î¼Î­ÏÎ±Ï‚</button>
      </div>
      <div class="pill small" style="margin-top:8px">Î•Ï€Î¹Î»Î¿Î³Î® ÎµÎ½ÎµÏÎ³Î®Ï‚ Î·Î¼Î­ÏÎ±Ï‚:</div>
      <div class="tabs" id="daysTabs" style="margin-top:8px"></div>
    </div>

    <div class="card draw-section">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h2>ÎšÎ»Î®ÏÏ‰ÏƒÎ· Î¸Î­ÏƒÎµÏ‰Î½ (ÎµÎ½ÎµÏÎ³Î® Î·Î¼Î­ÏÎ±)</h2>
        <div class="row" style="flex:0">
          <button class="primary" id="drawBtn">ğŸ² ÎšÎ»Î®ÏÏ‰ÏƒÎ·</button>
          <button class="ghost" id="printDrawBtn">ğŸ–¨ï¸ Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚</button>
          <button class="ghost" id="clearDrawBtn">â†©ï¸ Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        </div>
      </div>
      <div id="pegTags" style="margin-top:6px"></div>
      <div class="table-wrap" id="drawTableWrap" style="margin-top:8px"></div>
      <div class="small muted" style="margin-top:6px">
        ÎšÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î±: Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ¿ÏÏ‚ Ï„Î¿Î¼ÎµÎ¯Ï‚. Î‘Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Î»Î±Ï€Î»Î¬ÏƒÎ¹Î¿ Ï„Î¿Ï… 5, Î¿ Î• ÎµÎ¯Î½Î±Î¹ Â«Ï„ÎµÏ‡Î½Î¹ÎºÏŒÏ‚Â» ÎºÎ±Î¹ Î´Î±Î½ÎµÎ¯Î¶ÎµÏ„Î±Î¹ Î¿Ï…ÏÎ±Î³Î¿ÏÏ‚ Ï„Î¿Ï… D
        Î¼ÏŒÎ½Î¿ Î³Î¹Î± Ï„Î·Î½ ÎµÏƒÏ‰Ï„ÎµÏÎ¹ÎºÎ® ÎºÎ±Ï„Î¬Ï„Î±Î¾Î· Ï„Î¿Ï… Î•.
      </div>
    </div>
  </section>

  <!-- Î£Î•Î›Î™Î”Î‘: ÎšÎ‘Î¤Î‘Î“Î¡Î‘Î¦Î— -->
  <section id="p-entry" class="page" style="display:none">
    <div class="card">
      <h2>ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î±Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½ (ÎµÎ½ÎµÏÎ³Î® Î·Î¼Î­ÏÎ±)</h2>
      <div class="table-wrap" id="resultsTableWrap"></div>
    </div>
  </section>

  <!-- Î£Î•Î›Î™Î”Î‘: Î’Î‘Î˜ÎœÎŸÎ›ÎŸÎ“Î™Î•Î£ & Î‘ÎÎ‘Î¦ÎŸÎ¡Î•Î£ -->
  <section id="p-scores" class="page" style="display:none">
    <div class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h2>Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯ÎµÏ‚ & Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚</h2>
        <div class="row" style="flex:0">
          <button class="ghost" id="recalcBtn">ğŸ” Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button>
          <button class="ghost" id="exportCsvBtn">â¬‡ï¸ Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
          <button class="ghost" id="printBtn">ğŸ–¨ï¸ Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
          <button class="primary" id="pdfBtn">ğŸ§¾ Î‘Î½Î±Ï†Î¿ÏÎ¬ PDF</button>
        </div>
      </div>
      <div class="tabs" id="scoreTabs" style="margin-top:8px"></div>
      <div class="table-wrap" id="scoreTables"></div>
    </div>
  </section>

  <!-- Î£Î•Î›Î™Î”Î‘: Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ -->
  <section id="p-settings" class="page" style="display:none">
    <div class="card">
      <h2>Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</h2>
      <div class="row">
        <div><label>ÎŒÎ½Î¿Î¼Î± Î´Î¹Î¿ÏÎ³Î¬Î½Ï‰ÏƒÎ·Ï‚</label><input id="eventName" placeholder="Î .Ï‡. Î ÏÏ‰Ï„Î¬Î¸Î»Î·Î¼Î± 2025"></div>
        <div>
          <label>ÎšÎ±Î½ÏŒÎ½Î±Ï‚ Î¹ÏƒÎ¿Î²Î±Î¸Î¼Î¯Î±Ï‚ Î·Î¼Î­ÏÎ±Ï‚</label>
          <input value="Î’Î¬ÏÎ¿Ï‚ â†“ â†’ Î Î»Î®Î¸Î¿Ï‚ â†“ â†’ ÎœÎµÎ³. ÏˆÎ¬ÏÎ¹ â†“" disabled>
        </div>
      </div>
      <div class="small muted" style="margin-top:6px">
        Î—Î¼ÎµÏÎ®ÏƒÎ¹Î± Î±Ï„Î¿Î¼Î¹ÎºÎ®: Î¸Î­ÏƒÎ· **Î±Î½Î¬ Ï„Î¿Î¼Î­Î±**. Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Ï€ÏÏ‰Ï„Î¬Î¸Î»Î·Î¼Î± (Î±Ï„Î¿Î¼Î¹ÎºÏŒ): Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î±Ï…Ï„ÏÎ½ Ï„Ï‰Î½ Î¸Î­ÏƒÎµÏ‰Î½.
        Î˜Î­ÏƒÎµÎ¹Ï‚ ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚ 1..N Î±Î½Î±ÎºÎ±Ï„ÎµÏÎ¿Î½Ï„Î±Î¹ Ï„Ï…Ï‡Î±Î¯Î±.
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="ghost" id="saveStateBtn">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        <button class="ghost" id="loadStateBtn">ğŸ“‚ Î¦ÏŒÏÏ„Ï‰ÏƒÎ·</button>
        <button class="danger" id="resetBtn">ğŸ§¹ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
      </div>
    </div>
  </section>
</div>

<script>
/* ---------- PWA register ---------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
}

/* ---------- State ---------- */
const $ = (id) => document.getElementById(id);
const uid = () => Math.random().toString(36).slice(2,9);

const state = {
  settings: { eventName: "", sectors: ["A","B","C","D","E"] },
  athletes: [], // {id,name,club}
  days: [],     // {id,name,date, draw:{athId:{sector,peg}}, results:{athId:{weight,biggest,count,status}}}
  activeDayId: null,
  teamRosters: {} // club -> Î­Ï‰Ï‚ 5 athleteIds (ÎºÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î±)
};

function save(){ localStorage.setItem("alieia_sector_positions_state", JSON.stringify(state)); }
function load(){ const raw=localStorage.getItem("alieia_sector_positions_state"); if(!raw) return false; Object.assign(state, JSON.parse(raw)); return true; }

/* ---------- Router (ÏƒÎµÎ»Î¯Î´ÎµÏ‚) ---------- */
function showPage(pid){
  document.querySelectorAll(".page").forEach(p=> p.style.display = (p.id===pid? "block":"none"));
  document.querySelectorAll("nav button").forEach(b=> b.classList.toggle("active", b.dataset.page===pid));
  renderAll();
  location.hash = pid;
}
document.getElementById("topNav").addEventListener("click", (e)=>{
  if(e.target.tagName==="BUTTON"){ showPage(e.target.dataset.page); }
});
window.addEventListener("load", ()=>{
  const initial = location.hash?.slice(1) || "p-participants";
  showPage(initial);
});

/* ---------- Utils ---------- */
function escapeHtml(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j]] } return arr; }
function activeDay(){ return state.days.find(d=>d.id===state.activeDayId) || null; }
function sanitize(s){ return String(s).replaceAll(/[^a-zA-Z0-9\-_. ]+/g,"").replaceAll(" ","_"); }
function ceilDiv(a,b){ return Math.ceil(a/b); }

/* ---------- Participants UI ---------- */
function renderAthletes(){
  const wrap = $("athletesTableWrap");
  if(!wrap) return;
  if(state.athletes.length===0){ wrap.innerHTML = `<p class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ…Î¼Î¼ÎµÏ„Î­Ï‡Î¿Î½Ï„ÎµÏ‚ Î±ÎºÏŒÎ¼Î·.</p>`; return; }
  let html = `<table><thead><tr><th>#</th><th>Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½</th><th>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</th><th></th></tr></thead><tbody>`;
  state.athletes.forEach((a,i)=>{
    html += `<tr><td>${i+1}</td><td>${escapeHtml(a.name)}</td><td>${escapeHtml(a.club)}</td>
      <td><button class="danger" data-del="${a.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button></td></tr>`;
  });
  html += `</tbody></table>`;
  wrap.innerHTML = html;
  wrap.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.getAttribute("data-del");
      state.athletes=state.athletes.filter(x=>x.id!==id);
      state.days.forEach(d=>{ delete d.draw[id]; delete d.results[id]; });
      Object.keys(state.teamRosters).forEach(c=>{ state.teamRosters[c]=(state.teamRosters[c]||[]).filter(x=>x!==id); });
      renderAll(); save();
    };
  });
}
function renderTeams(){
  const wrap = $("teamsWrap"); if(!wrap) return; wrap.innerHTML="";
  const byClub = new Map();
  state.athletes.forEach(a=>{ const c=a.club?.trim()||"-"; if(!byClub.has(c)) byClub.set(c,[]); byClub.get(c).push(a); });
  byClub.forEach(arr=>arr.sort((a,b)=> a.name.localeCompare(b.name,'el')));
  byClub.forEach((members,club)=>{
    const box=document.createElement("div"); box.className="card";
    const chosen=new Set((state.teamRosters[club]||[]).slice(0,5));
    box.innerHTML = `<h3 style="margin:0 0 8px 0">${escapeHtml(club)} â€” ÎšÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î± <span class="muted small">(${chosen.size}/5)</span></h3>`;
    members.forEach(m=>{
      const id=`cb_${club}_${m.id}`;
      const row=document.createElement("div"); row.className="row"; row.style.alignItems="center";
      const chk=document.createElement("input"); chk.type="checkbox"; chk.id=id; chk.checked=chosen.has(m.id); chk.style.width="auto";
      chk.onchange=()=>{
        const list=new Set(state.teamRosters[club]||[]);
        if(chk.checked){ if(list.size>=5){ chk.checked=false; alert("ÎšÎ»ÎµÎ¹ÏƒÏ„Î® Ï€ÎµÎ½Ï„Î¬Î´Î±: Î¼Î­Ï‡ÏÎ¹ 5 Î¬Ï„Î¿Î¼Î±."); return; } list.add(m.id); }
        else list.delete(m.id);
        state.teamRosters[club]=[...list]; renderTeams(); save();
      };
      const lab=document.createElement("label"); lab.htmlFor=id; lab.textContent=m.name;
      row.appendChild(chk); row.appendChild(lab); box.appendChild(row);
    });
    wrap.appendChild(box);
  });
}

/* ---------- Days & Draw UI ---------- */
function renderDaysTabs(){
  const wrap = $("daysTabs"); if(!wrap) return; wrap.innerHTML="";
  if(state.days.length===0){ wrap.innerHTML = `<span class="muted small">ÎšÎ±Î¼Î¯Î± Î·Î¼Î­ÏÎ± Î±ÎºÏŒÎ¼Î·.</span>`; return; }
  state.days.forEach((d,i)=>{
    const b=document.createElement("button"); b.className="pill"; b.textContent=`${d.name||("Î—Î¼Î­ÏÎ± "+(i+1))}${d.date? " ("+d.date+")":""}`;
    if(d.id===state.activeDayId) b.style.borderColor="#22c55e";
    b.onclick=()=>{ state.activeDayId=d.id; renderAll(); save(); };
    wrap.appendChild(b);
  });
}
function renderPegTags(){
  const wrap=$("pegTags"); if(!wrap) return; wrap.innerHTML="";
  const N=state.athletes.length, per=ceilDiv(N,5);
  state.settings.sectors.forEach((sec,idx)=>{
    const left = Math.max(0, N - per*idx);
    const count = Math.min(per, left);
    const span=document.createElement("span"); span.className="pill";
    span.textContent = `${sec}: ${count} Î¸Î­ÏƒÎµÎ¹Ï‚` + ((idx===4 && (N%5)!==0) ? " (Î¤ÎµÏ‡Î½Î¹ÎºÏŒÏ‚)" : "");
    wrap.appendChild(span);
  });
  const note=document.createElement("div"); note.className="small muted";
  note.textContent="ÎŸÎ¹ Î±ÏÎ¹Î¸Î¼Î¿Î¯ Î¸Î­ÏƒÎµÏ‰Î½ 1..N Î±Î½Î±ÎºÎ±Ï„ÎµÏÎ¿Î½Ï„Î±Î¹ Ï„Ï…Ï‡Î±Î¯Î± ÏƒÎµ ÎºÎ¬Î¸Îµ ÎºÎ»Î®ÏÏ‰ÏƒÎ·.";
  wrap.appendChild(note);
}
function renderDraw(){
  const d=activeDay(); const wrap=$("drawTableWrap"); if(!wrap) return;
  if(!d){ wrap.innerHTML=`<p class="muted">Î•Ï€Î¯Î»ÎµÎ¾Îµ/Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î·Î¼Î­ÏÎ±.</p>`; return; }
  if(Object.keys(d.draw).length===0){ wrap.innerHTML=`<p class="muted">ÎšÎ±Î¼Î¯Î± ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î³Î¹Î± Ï„Î·Î½ Â«${escapeHtml(d.name)}Â».</p>`; return; }
  const rows = state.athletes.map(a=>({a, dd:d.draw[a.id]})).sort((x,y)=>{
    const xs=x.dd?x.dd.sector:""; const ys=y.dd?y.dd.sector:"";
    if(xs===ys){ const xp=x.dd?x.dd.peg:999999; const yp=y.dd?y.dd.peg:999999; return xp-yp;} return xs.localeCompare(ys);
  });
  let html = `<div class="small muted">${escapeHtml(state.settings.eventName||"")} â€” ${escapeHtml((activeDay()?.name)||"")} ${escapeHtml((activeDay()?.date)||"")}</div>
  <table><thead><tr><th>#</th><th>Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½</th><th>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</th><th>Î¤Î¿Î¼Î­Î±Ï‚</th><th>Î˜Î­ÏƒÎ·</th></tr></thead><tbody>`;
  rows.forEach((r,i)=>{ html += `<tr><td>${i+1}</td><td>${escapeHtml(r.a.name)}</td><td>${escapeHtml(r.a.club)}</td><td>${r.dd? r.dd.sector:"-"}</td><td>${r.dd? r.dd.peg:"-"}</td></tr>`; });
  html += `</tbody></table>`; wrap.innerHTML=html;
}

/* ---------- Entry UI ---------- */
function renderResults(){
  const d=activeDay(); const wrap=$("resultsTableWrap"); if(!wrap) return;
  if(!d){ wrap.innerHTML=`<p class="muted">Î•Ï€Î¯Î»ÎµÎ¾Îµ/Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î·Î¼Î­ÏÎ±.</p>`; return; }
  let html = `<table><thead><tr>
    <th>#</th><th>Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½</th><th>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</th><th>Î¤Î¿Î¼Î­Î±Ï‚</th><th>Î˜Î­ÏƒÎ·</th>
    <th>Î’Î¬ÏÎ¿Ï‚ (g)</th><th>Î Î»Î®Î¸Î¿Ï‚</th><th>ÎœÎµÎ³. ÏˆÎ¬ÏÎ¹ (g)</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
  </tr></thead><tbody>`;
  const rows = state.athletes.map(a=>({a, dd: d.draw[a.id]})).sort((x,y)=>{
    const xs=x.dd?x.dd.sector:""; const ys=y.dd?y.dd.sector:""; if(xs===ys){ const xp=x.dd?x.dd.peg:999999; const yp=y.dd?y.dd.peg:999999; return xp-yp;} return xs.localeCompare(ys);
  });
  rows.forEach((r,i)=>{
    const res = d.results[r.a.id] || {weight:0,biggest:0,count:0,status:"OK"};
    html += `<tr>
      <td>${i+1}</td><td>${escapeHtml(r.a.name)}</td><td>${escapeHtml(r.a.club||"")}</td>
      <td>${r.dd? r.dd.sector:"-"}</td><td>${r.dd? r.dd.peg:"-"}</td>
      <td><input type="number" min="0" data-id="${r.a.id}" data-f="weight" value="${res.weight}"></td>
      <td><input type="number" min="0" data-id="${r.a.id}" data-f="count" value="${res.count}"></td>
      <td><input type="number" min="0" data-id="${r.a.id}" data-f="biggest" value="${res.biggest}"></td>
      <td>
        <select data-id="${r.a.id}" data-f="status">
          <option value="OK" ${res.status==="OK"?"selected":""}>OK</option>
          <option value="DQ" ${res.status==="DQ"?"selected":""}>DQ</option>
          <option value="NS" ${res.status==="NS"?"selected":""}>NS</option>
        </select>
      </td>
    </tr>`;
  });
  html += `</tbody></table>`;
  wrap.innerHTML=html;
  wrap.querySelectorAll("input,select").forEach(el=>{
    el.oninput=()=>{
      const id=el.getAttribute("data-id"), f=el.getAttribute("data-f"); const d2=activeDay(); if(!d2) return;
      if(!d2.results[id]) d2.results[id]={weight:0,biggest:0,count:0,status:"OK"};
      let v=el.value; if(["weight","biggest","count"].includes(f)) v=Number(v||0);
      d2.results[id][f]=v; save();
    };
  });
}

/* ---------- Buttons & Settings ---------- */
function bindCommonButtons(){
  const b1=$("saveStateBtn"), b2=$("loadStateBtn"), b3=$("resetBtn");
  if(b1){ b1.onclick=()=>{ save(); alert("Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿Î½ browser."); }; }
  if(b2){ b2.onclick=()=>{ if(!load()) alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±."); renderAll(); }; }
  if(b3){ b3.onclick=()=>{ if(confirm("Î£Î¯Î³Î¿Ï…ÏÎ±; Î˜Î± Ï‡Î±Î¸Î¿ÏÎ½ ÏŒÎ»Î±.")){ localStorage.removeItem("alieia_sector_positions_state"); location.reload(); } }; }
}
function bindParticipants(){
  const add=$("addAthleteBtn"), bulk=$("addBulkBtn"), excelBtn=$("excelBtn"), excelInp=$("excelInput");
  if(add){ add.onclick=()=>{ const nm=$("athleteName").value.trim(); if(!nm) return; const club=$("club").value.trim(); state.athletes.push({id:uid(),name:nm,club}); $("athleteName").value=""; $("club").value=""; renderAll(); save(); }; }
  if(bulk){ bulk.onclick=()=>{ const txt=prompt("Î•Ï€Î¹ÎºÏŒÎ»Î»Î·ÏƒÎµ Î»Î¯ÏƒÏ„Î± (ÎŒÎ½Î¿Î¼Î±[, Î£ÏÎ»Î»Î¿Î³Î¿Ï‚]) â€” Î¼Î¯Î± Î±Î½Î¬ Î³ÏÎ±Î¼Î¼Î®",""); if(!txt) return; txt.split("\n").map(x=>x.trim()).filter(Boolean).forEach(line=>{ const [name,club]=line.split(","); state.athletes.push({id:uid(),name:name?.trim()||"",club:club?.trim()||""}); }); renderAll(); save(); }; }
  if(excelBtn && excelInp){ excelBtn.onclick=()=>excelInp.click(); excelInp.onchange=excelImport; }
}
function bindDays(){
  const add=$("addDayBtn"); if(add){ add.onclick=()=>{ const name=$("dayName").value.trim()||`Î—Î¼Î­ÏÎ± ${state.days.length+1}`; const date=$("dayDate").value||""; const id=uid(); state.days.push({id,name,date,draw:{},results:{}}); state.activeDayId=id; $("dayName").value=""; $("dayDate").value=""; renderAll(); save(); }; }
}
function bindDrawButtons(){
  const dBtn=$("drawBtn"), prBtn=$("printDrawBtn"), clrBtn=$("clearDrawBtn");
  if(dBtn){ dBtn.onclick=()=>{ const d=activeDay(); if(!d){ alert("Î•Ï€Î¯Î»ÎµÎ¾Îµ/Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î·Î¼Î­ÏÎ±."); return; } doDrawForDay(d); renderDraw(); renderResults(); renderScores(); save(); }; }
  if(prBtn){ prBtn.onclick=()=>{ document.body.classList.add('print-draw'); window.print(); setTimeout(()=>document.body.classList.remove('print-draw'),0); }; }
  if(clrBtn){ clrBtn.onclick=()=>{ const d=activeDay(); if(!d) return; d.draw={}; renderDraw(); renderResults(); renderScores(); save(); }; }
}
function bindScoresButtons(){
  const recalc=$("recalcBtn"), printBtn=$("printBtn"), csvBtn=$("exportCsvBtn"), pdfBtn=$("pdfBtn");
  if(recalc){ recalc.onclick=()=> renderScores(); }
  if(printBtn){ printBtn.onclick=()=> window.print(); }
  if(csvBtn){ csvBtn.onclick=()=> exportCSV(); }
  if(pdfBtn){ pdfBtn.onclick=()=> exportPDF(); }
}
function bindSettings(){
  const ev=$("eventName"); if(ev){ ev.oninput=e=>{ state.settings.eventName=e.target.value; save(); }; }
}

/* ---------- Scoring (Î±Î½Î¬ Ï„Î¿Î¼Î­Î±) ---------- */
function sectorOrder(){ return state.settings.sectors; } // ["A","B","C","D","E"]

// Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹: {ordered, placeMap, sectorMaxMap}
function scoreDay(dayId){
  const d = state.days.find(x=>x.id===dayId); if(!d) return {ordered:[], placeMap:new Map(), sectorMaxMap:new Map()};
  const N = state.athletes.length, per = ceilDiv(N,5);

  const bySec = new Map(sectorOrder().map(s=>[s,[]]));
  state.athletes.forEach(a=>{
    const dd=d.draw[a.id]; const r=d.results[a.id]||{weight:0,biggest:0,count:0,status:"OK"};
    if(!dd || r.status!=="OK") return;
    bySec.get(dd.sector).push({id:a.id,name:a.name,club:a.club,sector:dd.sector,peg:dd.peg,weight:r.weight||0,biggest:r.biggest||0,count:r.count||0});
  });

  // Î¤ÎµÏ‡Î½Î¹ÎºÏŒÏ‚ Î•: Î´Î±Î½ÎµÎ¯Î¶ÎµÏ„Î±Î¹ Î¿Ï…ÏÎ±Î³Î¿ÏÏ‚ D Î³Î¹Î± Î½Î± Ï†Ï„Î¬ÏƒÎµÎ¹ per (Î¼ÏŒÎ½Î¿ ÎµÏƒÏ‰Ï„ÎµÏÎ¹ÎºÎ® ÎºÎ±Ï„Î¬Ï„Î±Î¾Î· Î•)
  const E = bySec.get("E"), D = bySec.get("D");
  if(E && D && E.length < per){
    const need = per - E.length;
    const donors = [...D].sort((a,b)=>a.peg-b.peg).slice(-need).map(x=> ({...x, borrowedFrom:"D"}));
    E.push(...donors);
  }

  const placeMap = new Map();
  const sectorMaxMap = new Map();

  sectorOrder().forEach(sec=>{
    const arr = bySec.get(sec);
    arr.sort((a,b)=> (b.weight-a.weight) || (b.count-a.count) || (b.biggest-a.biggest) || a.id.localeCompare(b.id));
    sectorMaxMap.set(sec, Math.max(arr.length, per));
    let place=1;
    arr.forEach(row=>{
      if(sec!=="E" || !row.borrowedFrom){ placeMap.set(row.id, {sec, place}); }
      place++;
    });
  });

  const ordered = [];
  sectorOrder().forEach(sec=>{
    (bySec.get(sec)||[]).forEach(r=>{
      const pl = placeMap.get(r.id);
      ordered.push({...r, place: (pl && pl.sec===sec)? pl.place : (r.borrowedFrom? "(Î´Î±Î½.)" : null)});
    });
  });
  return {ordered, placeMap, sectorMaxMap};
}

// Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î‘Ï„Î¿Î¼Î¹ÎºÏŒ (Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¸Î­ÏƒÎµÏ‰Î½ Ï„Î¿Î¼Î­Î± Î±Î½Î¬ Î·Î¼Î­ÏÎ±)
function scoreAggregate(){
  const acc=new Map(); state.athletes.forEach(a=> acc.set(a.id,{id:a.id,name:a.name,club:a.club, total_place:0, days:0, total_weight:0, total_count:0, best_biggest:0}));
  state.days.forEach(d=>{
    const sc = scoreDay(d.id);
    state.athletes.forEach(a=>{
      const dd = d.draw[a.id]; const sec = dd? dd.sector : null;
      const r = d.results[a.id];
      const secMax = sec? (sc.sectorMaxMap.get(sec)||0) : 0;
      const entry = acc.get(a.id);
      const pl = sc.placeMap.get(a.id);
      const place = (pl && pl.sec===sec)? pl.place : (secMax>0? (secMax+1) : 0); // NS/DQ/Ï‡Ï‰ÏÎ¯Ï‚ ÎºÎ»Î®ÏÏ‰ÏƒÎ· â†’ MAX+1 Ï„Î¿Ï… Ï„Î¿Î¼Î­Î±
      if(sec){ entry.total_place += place; entry.days += 1; }
      if(r && r.status==="OK"){ entry.total_weight += (r.weight||0); entry.total_count += (r.count||0); entry.best_biggest = Math.max(entry.best_biggest, (r.biggest||0)); }
    });
  });
  const rows=[...acc.values()];
  rows.sort((a,b)=> (a.total_place-b.total_place) || (b.total_weight-a.total_weight) || (b.total_count-a.total_count) || (b.best_biggest-a.best_biggest) || a.name.localeCompare(b.name,'el'));
  return rows;
}

/* ---------- ÎŸÎ¼Î±Î´Î¹ÎºÏŒ (ÎºÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î±) Î±Ï€ÏŒ Î¸Î­ÏƒÎµÎ¹Ï‚ Ï„Î¿Î¼Î­Î± ---------- */
function getClubs(){ return [...new Set(state.athletes.map(a=>a.club?.trim()||"-"))]; }
function teamRoster(club){ return (state.teamRosters[club]||[]).filter(id=> state.athletes.find(a=>a.id===id)).slice(0,5); }
function teamScoreDay(dayId){
  const d = state.days.find(x=>x.id===dayId); if(!d) return [];
  const sc = scoreDay(dayId);
  const teams=[];
  getClubs().forEach(club=>{
    const roster = teamRoster(club); if(roster.length===0) return;
    let sum=0, w=0; const names=[];
    roster.forEach(id=>{
      const a=state.athletes.find(x=>x.id===id); names.push(a? a.name:"â€”");
      const dd=d.draw[id]; const sec=dd? dd.sector:null;
      const secMax = sec? (sc.sectorMaxMap.get(sec)||0) : 0;
      const pl = sc.placeMap.get(id);
      const place = (pl && pl.sec===sec)? pl.place : (secMax+1);
      sum += place;
      const rr=d.results[id]; if(rr && rr.status==="OK") w += (rr.weight||0);
    });
    teams.push({club, team_place_sum:sum, team_weight:w, members:names});
  });
  teams.sort((a,b)=> (a.team_place_sum-b.team_place_sum) || (b.team_weight-a.team_weight) || a.club.localeCompare(b.club,'el'));
  return teams;
}
function teamScoreAggregate(){
  const acc=new Map(); getClubs().forEach(c=> acc.set(c,{club:c, place_sum:0, weight_sum:0, days:0}));
  state.days.forEach(d=>{
    const t = teamScoreDay(d.id);
    const byClub=new Map(t.map(x=>[x.club,x]));
    acc.forEach((v,c)=>{ const x=byClub.get(c); if(x){ v.place_sum+=x.team_place_sum; v.weight_sum+=x.team_weight; v.days+=1; } });
  });
  const rows=[...acc.values()];
  rows.sort((a,b)=> (a.place_sum-b.place_sum) || (b.weight_sum-a.weight_sum) || a.club.localeCompare(b.club,'el'));
  return rows;
}

/* ---------- ÎšÎ»Î®ÏÏ‰ÏƒÎ· (ÎºÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î± ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ¿ÏÏ‚ Ï„Î¿Î¼ÎµÎ¯Ï‚) + shuffled pegs ---------- */
function doDrawForDay(d){
  const sectors = state.settings.sectors; // A..E
  const N = state.athletes.length;
  const per = ceilDiv(N,5); // ÏƒÏ„ÏŒÏ‡Î¿Ï‚/Ï„Î¿Î¼Î­Î±
  const buckets = new Map(sectors.map(s=>[s, new Array(per).fill(null)]));
  const clubInSector = new Map(sectors.map(s=>[s, new Set()])); // Î³Î¹Î± ÎºÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î±
  const sectorCap = new Map(sectors.map(s=>[s,0]));
  const rosterSet = new Set(); Object.values(state.teamRosters).forEach(arr=> arr.slice(0,5).forEach(id=> rosterSet.add(id)));
  const rosterAthletes = state.athletes.filter(a=> rosterSet.has(a.id));
  const otherAthletes = state.athletes.filter(a=> !rosterSet.has(a.id));
  shuffle(rosterAthletes); shuffle(otherAthletes);

  let violations=0;
  function placeIn(sec, id, club){
    const arr=buckets.get(sec); const idx=arr.findIndex(x=>x===null); if(idx===-1) return false;
    arr[idx]=id; sectorCap.set(sec, sectorCap.get(sec)+1); return true;
  }
  // Î ÏÏÏ„Î± Î· ÎºÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î±, Î±Ï€Î¿Ï†ÎµÏÎ³Î¿Î½Ï„Î±Ï‚ Î¯Î´Î¹Î¿ ÏƒÏÎ»Î»Î¿Î³Î¿ ÏƒÏ„Î¿Î½ Î¯Î´Î¹Î¿ Ï„Î¿Î¼Î­Î±
  rosterAthletes.forEach(a=>{
    const c=a.club?.trim()||"-";
    const choices = sectors.filter(s=> !clubInSector.get(s).has(c) && sectorCap.get(s)<per);
    const fallback = sectors.filter(s=> sectorCap.get(s)<per);
    const pickFrom = choices.length? choices : fallback;
    const sec = pickFrom.sort((s1,s2)=> sectorCap.get(s1)-sectorCap.get(s2))[0];
    if(!choices.length) violations++;
    placeIn(sec, a.id, c); clubInSector.get(sec).add(c);
  });
  // ÎœÎµÏ„Î¬ Î¿Î¹ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿Î¹ Î³Î¹Î± Î¹ÏƒÎ¿ÎºÎ±Ï„Î±Î½Î¿Î¼Î®
  otherAthletes.forEach(a=>{
    const sec = sectors.sort((s1,s2)=> sectorCap.get(s1)-sectorCap.get(s2))[0];
    placeIn(sec, a.id, a.club?.trim()||"-");
  });

  // Î‘Î½Î¬Î¸ÎµÏƒÎ· Î¸Î­ÏƒÎµÏ‰Î½ 1..N Î±Î½Î±ÎºÎ±Ï„ÎµÎ¼Î­Î½ÎµÏ‚ (Ï„Ï…Ï‡Î±Î¯Î±)
  const shuffledPegNumbers = Array.from({length:N}, (_,i)=>i+1);
  shuffle(shuffledPegNumbers);

  d.draw = {};
  let pegIdx = 0;
  sectors.forEach(sec=>{
    const list=(buckets.get(sec)||[]).filter(Boolean);
    list.forEach((athId)=>{
      if(pegIdx < shuffledPegNumbers.length){
        d.draw[athId] = {sector:sec, peg: shuffledPegNumbers[pegIdx++]};
      }
    });
  });

  if(violations>0){
    alert(`Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·: Î”ÎµÎ½ Î®Ï„Î±Î½ ÎµÏ†Î¹ÎºÏ„ÏŒÏ‚ Î¿ Ï€Î»Î®ÏÎ·Ï‚ Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î¼ÎµÎ»ÏÎ½ ÎºÎ»ÎµÎ¹ÏƒÏ„Î®Ï‚ 5Î¬Î´Î±Ï‚ ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ¿ÏÏ‚ Ï„Î¿Î¼ÎµÎ¯Ï‚ (${violations} Ï€ÎµÏÎ¹Ï€Ï„ÏÏƒÎµÎ¹Ï‚).`);
  }
}

/* ---------- Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯ÎµÏ‚ & Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚ (UI) ---------- */
function tab(label,cb){ const b=document.createElement("button"); b.className="pill"; b.textContent=label; b.onclick=cb; return b; }
function makeTable(rows,title,headers){
  let html = `<h3 style="margin:6px 0">${escapeHtml(title)}</h3><table><thead><tr>${headers.map(h=>`<th>${escapeHtml(h)}</th>`).join("")}</tr></thead><tbody>`;
  rows.forEach(r=>{ html += `<tr>${r.map(c=>`<td>${escapeHtml(String(c))}</td>`).join("")}</tr>`); });
  html += `</tbody></table>`; return html;
}
function renderScores(){
  const tabs=$("scoreTabs"), area=$("scoreTables"); if(!tabs || !area) return; tabs.innerHTML=""; area.innerHTML="";
  const d=activeDay();

  // 1) Î—Î¼Î­ÏÎ± (Î‘Ï„Î¿Î¼Î¹ÎºÏŒ Î±Î½Î¬ Î¤Î¿Î¼Î­Î±)
  if(d){
    const btnDay = tab(`Î—Î¼Î­ÏÎ±: ${d.name} â€” Î‘Ï„Î¿Î¼Î¹ÎºÏŒ Î±Î½Î¬ Î¤Î¿Î¼Î­Î±`, ()=>{
      const day = scoreDay(d.id);
      const rs = day.ordered.map((r,i)=>[i+1,r.sector,r.name,r.club||"",r.weight,r.count,r.biggest,r.place]);
      area.innerHTML = makeTable(rs,`ÎšÎ±Ï„Î¬Ï„Î±Î¾Î· Î—Î¼Î­ÏÎ±Ï‚ Î±Î½Î¬ Î¤Î¿Î¼Î­Î± â€” Î’Î¬ÏÎ¿Ï‚ â†’ Î Î»Î®Î¸Î¿Ï‚ â†’ ÎœÎµÎ³. ÏˆÎ¬ÏÎ¹`, ["#","Î¤Î¿Î¼Î­Î±Ï‚","Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î’Î¬ÏÎ¿Ï‚(g)","Î Î»Î®Î¸Î¿Ï‚","ÎœÎµÎ³.Î¨Î¬ÏÎ¹(g)","Î˜Î­ÏƒÎ· Î¤Î¿Î¼Î­Î±"]);
    }); tabs.appendChild(btnDay); btnDay.click();
  }

  // 2) Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î ÏÏ‰Ï„Î¬Î¸Î»Î·Î¼Î± (Î‘Ï„Î¿Î¼Î¹ÎºÏŒ â€” Î±Ï€ÏŒ Î¸Î­ÏƒÎµÎ¹Ï‚ Ï„Î¿Î¼Î­Î±)
  const btnAgg = tab("Î£ÏÎ½Î¿Î»Î¿ Î ÏÏ‰Ï„Î±Î¸Î»Î®Î¼Î±Ï„Î¿Ï‚ (Î‘Ï„Î¿Î¼Î¹ÎºÏŒ â€” Î±Ï€ÏŒ Î¸Î­ÏƒÎµÎ¹Ï‚ Ï„Î¿Î¼Î­Î±)", ()=>{
    const rows = scoreAggregate().map((r,i)=>[i+1,r.name,r.club||"",r.days,r.total_place,r.total_weight,r.total_count,r.best_biggest]);
    area.innerHTML = makeTable(rows,"Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î‘Ï„Î¿Î¼Î¹ÎºÎ® ÎšÎ±Ï„Î¬Ï„Î±Î¾Î· (Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¸Î­ÏƒÎµÏ‰Î½ Ï„Î¿Î¼Î­Î± Î±Î½Î¬ Î·Î¼Î­ÏÎ±)",["#","Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î—Î¼Î­ÏÎµÏ‚","Î£ÏÎ½Î¿Î»Î¿ Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½. Î’Î¬ÏÎ¿Ï‚","Î£Ï…Î½. Î Î»Î®Î¸Î¿Ï‚","ÎšÎ±Î». ÎœÎµÎ³.Î¨Î¬ÏÎ¹"]);
  }); tabs.appendChild(btnAgg);

  // 3) ÎŸÎ¼Î±Î´Î¹ÎºÏŒ â€” Î—Î¼Î­ÏÎ±Ï‚ (Î±Ï€ÏŒ Î¸Î­ÏƒÎµÎ¹Ï‚ Ï„Î¿Î¼Î­Î±)
  if(d){
    const btnTeamDay = tab(`Î—Î¼Î­ÏÎ±: ${d.name} â€” ÎŸÎ¼Î±Î´Î¹ÎºÏŒ 5Î¬Î´Î±Ï‚`, ()=>{
      const rows = teamScoreDay(d.id).map((t,i)=>[i+1,t.club,t.members.join(", "),t.team_place_sum,t.team_weight]);
      area.innerHTML = makeTable(rows,`ÎŸÎ¼Î±Î´Î¹ÎºÏŒ Î—Î¼Î­ÏÎ±Ï‚ (ÎºÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î± â€” Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¸Î­ÏƒÎµÏ‰Î½ Ï„Î¿Î¼Î­Î±)`,["#","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","5Î¬Î´Î±","Î†Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚"]);
    }); tabs.appendChild(btnTeamDay);
  }

  // 4) ÎŸÎ¼Î±Î´Î¹ÎºÏŒ â€” Î ÏÏ‰Ï„Î¬Î¸Î»Î·Î¼Î±
  const btnTeamAgg = tab("Î£ÏÎ½Î¿Î»Î¿ Î ÏÏ‰Ï„Î±Î¸Î»Î®Î¼Î±Ï„Î¿Ï‚ (ÎŸÎ¼Î±Î´Î¹ÎºÏŒ 5Î¬Î´Î±Ï‚)", ()=>{
    const rows = teamScoreAggregate().map((t,i)=>[i+1,t.club,t.place_sum,t.weight_sum,t.days]);
    area.innerHTML = makeTable(rows,"ÎŸÎ¼Î±Î´Î¹ÎºÏŒ Î ÏÏ‰Ï„Î±Î¸Î»Î®Î¼Î±Ï„Î¿Ï‚ (Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¸Î­ÏƒÎµÏ‰Î½ Ï„Î¿Î¼Î­Î± Î±Î½Î¬ Î·Î¼Î­ÏÎ±)",["#","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î£ÏÎ½Î¿Î»Î¿ Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚","Î—Î¼Î­ÏÎµÏ‚"]);
  }); tabs.appendChild(btnTeamAgg);
}

/* ---------- Import/Export ---------- */
function excelImport(ev){
  const file=ev.target.files[0]; if(!file) return;
  const name=file.name.toLowerCase(); const reader=new FileReader();
  if(name.endsWith(".csv")){
    reader.onload=()=>{
      const lines=reader.result.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      lines.forEach(line=>{ const [nm,club] = line.split(","); if(nm) state.athletes.push({id:uid(),name:nm.trim(),club:(club||"").trim()}); });
      renderAll(); save(); ev.target.value="";
    }; reader.readAsText(file,"utf-8");
  } else {
    reader.onload=(e)=>{
      const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:"array"});
      const ws=wb.Sheets[wb.SheetNames[0]]; const arr=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
      arr.forEach((row,idx)=>{ if(idx===0 && String(row[0]).toLowerCase().includes("Î¿Î½Î¿Î¼Î±")) return;
        const nm=String(row[0]||"").trim(); if(!nm) return; const club=String(row[1]||"").trim();
        state.athletes.push({id:uid(), name:nm, club});
      });
      renderAll(); save(); ev.target.value="";
    }; reader.readAsArrayBuffer(file);
  }
}
function exportCSV(){
  const agg = scoreAggregate().map((r,i)=>[i+1,r.name,r.club||"",r.days,r.total_place,r.total_weight,r.total_count,r.best_biggest]);
  const headAgg = ["#","ÎŒÎ½Î¿Î¼Î±","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î—Î¼Î­ÏÎµÏ‚","Î£ÏÎ½Î¿Î»Î¿ Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚","Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î Î»Î®Î¸Î¿Ï‚","ÎšÎ±Î»ÏÏ„ÎµÏÎ¿ ÎœÎµÎ³.Î¨Î¬ÏÎ¹"];
  const csvAgg = [headAgg, ...agg].map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");

  const teamsAgg = teamScoreAggregate().map((t,i)=>[i+1,t.club,t.place_sum,t.weight_sum,t.days]);
  const headTA = ["#","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î£ÏÎ½Î¿Î»Î¿ Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚","Î—Î¼Î­ÏÎµÏ‚"];
  const csvTA = [headTA, ...teamsAgg].map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");

  const d=activeDay(); let csvDay="", csvTeamDay="";
  if(d){
    const day=scoreDay(d.id);
    const dayRows = day.ordered.map((r,i)=>[i+1,r.sector,r.name,r.club||"",d.name,d.date||"",r.weight,r.count,r.biggest,r.place,r.peg]);
    const headDay = ["#","Î¤Î¿Î¼Î­Î±Ï‚","ÎŒÎ½Î¿Î¼Î±","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î—Î¼Î­ÏÎ±","Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±","Î’Î¬ÏÎ¿Ï‚(g)","Î Î»Î®Î¸Î¿Ï‚","ÎœÎµÎ³.Î¨Î¬ÏÎ¹(g)","Î˜Î­ÏƒÎ· Î¤Î¿Î¼Î­Î±","Î˜Î­ÏƒÎ·"];
    csvDay = [headDay, ...dayRows].map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");

    const tRows = teamScoreDay(d.id).map((t,i)=>[i+1,t.club,t.members.join(" | "),t.team_place_sum,t.team_weight]);
    const headTD = ["#","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","5Î¬Î´Î±","Î†Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚"];
    csvTeamDay = [headTD, ...tRows].map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
  }

  const files = [
    {name:"atomiko-synolo-thesi_sector.csv", data:csvAgg},
    {name:"omadiko-synolo-thesi_sector.csv", data:csvTA},
    ...(d? [{name:`atomiko-${sanitize(d.name)}_sector.csv`, data:csvDay},
            {name:`omadiko-${sanitize(d.name)}_sector.csv`, data:csvTeamDay}]:[])
  ];
  files.forEach(p=>{
    const blob=new Blob([p.data],{type:"text/csv;charset=utf-8"}); const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download=p.name; a.click(); URL.revokeObjectURL(url);
  });
}
async function exportPDF(){
  const { jsPDF } = window.jspdf || {}; if(!jsPDF || !("autoTable" in (window.jspdf?.jsPDF?.prototype||{}))){ alert("Î›ÎµÎ¯Ï€ÎµÎ¹ jsPDF/autoTable."); return; }
  const doc=new jsPDF({unit:"pt",format:"a4"}), margin=36; const title=state.settings.eventName||"Î‘Î³ÏÎ½Î±Ï‚ Î‘Î¸Î»Î·Ï„Î¹ÎºÎ®Ï‚ Î‘Î»Î¹ÎµÎ¯Î±Ï‚";
  doc.setFont("helvetica","bold"); doc.setFontSize(16); doc.text(title, margin, 44);

  // ÎŸÎ¼Î±Î´Î¹ÎºÏŒ ÏƒÏÎ½Î¿Î»Î¿
  doc.setFont("helvetica","normal"); doc.setFontSize(12); doc.text("ÎŸÎ¼Î±Î´Î¹ÎºÏŒ Î ÏÏ‰Ï„Î±Î¸Î»Î®Î¼Î±Ï„Î¿Ï‚ (Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¸Î­ÏƒÎµÏ‰Î½ Ï„Î¿Î¼Î­Î± 5Î¬Î´Î±Ï‚)", margin, 70);
  const teamsAgg = teamScoreAggregate().map((t,i)=>[i+1,t.club,t.place_sum,t.weight_sum,t.days]);
  doc.autoTable({startY:80, margin:{left:margin,right:margin}, head:[["#","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î£ÏÎ½Î¿Î»Î¿ Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚","Î—Î¼Î­ÏÎµÏ‚"]], body:teamsAgg});
  let y = doc.lastAutoTable.finalY + 24;

  // Î‘Ï„Î¿Î¼Î¹ÎºÏŒ ÏƒÏÎ½Î¿Î»Î¿
  doc.text("Î‘Ï„Î¿Î¼Î¹ÎºÏŒ Î ÏÏ‰Ï„Î±Î¸Î»Î®Î¼Î±Ï„Î¿Ï‚ (Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¸Î­ÏƒÎµÏ‰Î½ Ï„Î¿Î¼Î­Î± Î±Î½Î¬ Î·Î¼Î­ÏÎ±)", margin, y);
  const agg = scoreAggregate().map((r,i)=>[i+1,r.name,r.club||"",r.days,r.total_place,r.total_weight,r.total_count,r.best_biggest]);
  doc.autoTable({startY:y+10, margin:{left:margin,right:margin}, head:[["#","Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î—Î¼Î­ÏÎµÏ‚","Î£ÏÎ½Î¿Î»Î¿ Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½. Î’Î¬ÏÎ¿Ï‚","Î£Ï…Î½. Î Î»Î®Î¸Î¿Ï‚","ÎšÎ±Î». ÎœÎµÎ³.Î¨Î¬ÏÎ¹"]], body:agg});
  y = doc.lastAutoTable.finalY + 24;

  // ÎšÎ¬Î¸Îµ Î·Î¼Î­ÏÎ± â€” Î‘Î½Î¬ Î¤Î¿Î¼Î­Î± & ÎŸÎ¼Î±Î´Î¹ÎºÏŒ Î·Î¼Î­ÏÎ±Ï‚
  for(const d of state.days){
    if(y>760){ doc.addPage(); y=margin; }
    doc.setFont("helvetica","bold"); doc.text(`Î—Î¼Î­ÏÎ±: ${d.name}${d.date? " ("+d.date+")":""}`, margin, y);
    const day = scoreDay(d.id);
    const ind = day.ordered.map((r,i)=>[i+1,r.sector,r.name,r.club||"",r.weight,r.count,r.biggest,r.place,r.peg]);
    doc.autoTable({startY:y+10, margin:{left:margin,right:margin},
      head:[["#","Î¤Î¿Î¼Î­Î±Ï‚","Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î’Î¬ÏÎ¿Ï‚(g)","Î Î»Î®Î¸Î¿Ï‚","ÎœÎµÎ³.Î¨Î¬ÏÎ¹(g)","Î˜Î­ÏƒÎ· Î¤Î¿Î¼Î­Î±","Î˜Î­ÏƒÎ·"]], body:ind});
    y = doc.lastAutoTable.finalY + 10;

    const tRows = teamScoreDay(d.id).map((t,i)=>[i+1,t.club,t.members.join(", "),t.team_place_sum,t.team_weight]);
    doc.autoTable({startY:y, margin:{left:margin,right:margin}, head:[["#","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","5Î¬Î´Î±","Î†Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚"]], body:tRows});
    y = doc.lastAutoTable.finalY + 20;
  }
  doc.save(`Anafora-${sanitize(title)}.pdf`);
}

/* ---------- Init & Render ---------- */
function renderAll(){
  const ev=$("eventName"); if(ev) ev.value = state.settings.eventName||"";
  renderAthletes();
  renderTeams();
  renderDaysTabs();
  renderPegTags();
  renderDraw();
  renderResults();
  renderScores();
}
function init(){
  load();
  if(state.days.length===0){ const id=uid(); state.days.push({id,name:"Î—Î¼Î­ÏÎ± 1",date:"",draw:{},results:{}}); state.activeDayId=id; }
  else if(!state.activeDayId){ state.activeDayId=state.days[0].id; }
  bindCommonButtons(); bindParticipants(); bindDays(); bindDrawButtons(); bindScoresButtons(); bindSettings();
  renderAll();
}
init();
</script>
</body>
</html>
