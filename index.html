<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#22c55e" />
<title>Î‘Î¸Î»Î·Ï„Î¹ÎºÎ® Î‘Î»Î¹ÎµÎ¯Î± â€” ÎšÎ»Î®ÏÏ‰ÏƒÎ· & Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± (Mobile + PWA)</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --line:#1f2937; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(120deg,#0b1023,#111827);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{padding:16px;border-bottom:1px solid var(--line);background:rgba(15,23,42,.9);backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:18px}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  nav button{padding:10px 14px;border-radius:12px;border:1px solid #273244;background:#0b1220;color:var(--ink);cursor:pointer;min-height:44px;font-size:16px}
  nav button.active{background:var(--accent);color:#07120c;border-color:transparent;font-weight:700}
  .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px}
  .row{display:flex;gap:8px}
  .row>*{flex:1}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid #273244;background:#0b1220;color:var(--ink);min-height:44px;font-size:16px}
  button.primary{background:var(--accent);border-color:transparent;color:#0b1020;font-weight:700;cursor:pointer}
  button.warn{background:var(--warn);color:#091015;border-color:transparent;cursor:pointer}
  button.ghost{background:#0b1220;cursor:pointer}
  button.danger{background:var(--danger);border-color:transparent;color:#fff;cursor:pointer}
  .muted{color:var(--muted)} .small{font-size:12px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #223255;font-size:12px;margin:2px 4px 0 0}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;white-space:nowrap}
  th{font-size:12px;color:var(--muted);font-weight:600}
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .table-wrap table{min-width:720px}
  @media print { body.print-draw .card:not(.draw-section){ display:none !important; } body.print-draw header, body.print-draw nav{display:none} body.print-draw .draw-section{ border:none; box-shadow:none } }
  @media (max-width:900px){ .row{flex-direction:column} }
</style>
</head>
<body>
<header>
  <h1>ğŸ£ Î‘Î¸Î»Î·Ï„Î¹ÎºÎ® Î‘Î»Î¹ÎµÎ¯Î± â€” ÎšÎ»Î®ÏÏ‰ÏƒÎ· & Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±</h1>
  <nav id="topNav">
    <button data-page="p-participants" class="active">Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Î¿Î½Ï„ÎµÏ‚</button>
    <button data-page="p-draw">Î—Î¼Î­ÏÎµÏ‚ & ÎšÎ»Î®ÏÏ‰ÏƒÎ·</button>
    <button data-page="p-entry">ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î®</button>
    <button data-page="p-scores">Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯ÎµÏ‚</button>
    <button data-page="p-settings">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
  </nav>
</header>

<div class="wrap">
  <!-- Î£Î¥ÎœÎœÎ•Î¤Î•Î§ÎŸÎÎ¤Î•Î£ -->
  <section id="p-participants" class="page">
    <div class="card">
      <h2>Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Î¿Î½Ï„ÎµÏ‚ (Î£ÏÎ»Î»Î¿Î³Î¿Ï‚)</h2>
      <div class="row">
        <div><label>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</label><input id="athleteName" placeholder="Ï€.Ï‡. ÎÎ¯ÎºÎ¿Ï‚ Î Î±Ï€Î±Î´ÏŒÏ€Î¿Ï…Î»Î¿Ï‚"></div>
        <div><label>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</label><input id="club" placeholder="Ï€.Ï‡. Î.ÎŸ. Î ÏŒÎ»Î·Ï‚"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="primary" id="addAthleteBtn">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
        <button class="ghost" id="addBulkBtn">ğŸ“¥ ÎœÎ±Î¶Î¹ÎºÎ® ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®</button>
        <input id="excelInput" type="file" accept=".xlsx,.xls,.csv" style="display:none">
        <button class="warn" id="excelBtn">ğŸ—‚ï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Î±Ï€ÏŒ Excel/CSV</button>
      </div>
      <div class="small muted" style="margin-top:4px">CSV: <code>ÎŒÎ½Î¿Î¼Î±, Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</code></div>
    </div>
    <div class="card"><div class="table-wrap" id="athletesTableWrap"></div></div>

    <div class="card">
      <h2>ÎŸÎ¼Î±Î´Î¹ÎºÏŒ â€” ÎšÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î± Î±Î½Î¬ Î£ÏÎ»Î»Î¿Î³Î¿</h2>
      <div id="teamsWrap" class="small"></div>
      <div class="small muted">NS/DQ ÏƒÏ„Î· 5Î¬Î´Î± â†’ Î¸Î­ÏƒÎ· MAX+1 Î³Î¹Î± Ï„Î· Î¼Î­ÏÎ± (MAX = Î¼Î­Î³ÎµÎ¸Î¿Ï‚ Ï„Î¿Î¼Î­Î±).</div>
    </div>
  </section>

  <!-- Î—ÎœÎ•Î¡Î•Î£ & ÎšÎ›Î—Î¡Î©Î£Î— -->
  <section id="p-draw" class="page" style="display:none">
    <div class="card">
      <h2>Î—Î¼Î­ÏÎµÏ‚</h2>
      <div class="row" style="margin-top:8px">
        <button class="primary" id="addDayBtn">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î·Î¼Î­ÏÎ±Ï‚</button>
      </div>
      <div class="pill small" style="margin-top:8px">Î•Ï€Î¹Î»Î¿Î³Î® ÎµÎ½ÎµÏÎ³Î®Ï‚ Î·Î¼Î­ÏÎ±Ï‚:</div>
      <div class="tabs" id="daysTabs" style="margin-top:8px"></div>
    </div>

    <div class="card draw-section">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h2>ÎšÎ»Î®ÏÏ‰ÏƒÎ· Î¸Î­ÏƒÎµÏ‰Î½ (ÎµÎ½ÎµÏÎ³Î® Î·Î¼Î­ÏÎ±)</h2>
        <div class="row" style="flex:0;gap:6px">
          <button class="primary" id="drawBtn">ğŸ² ÎšÎ»Î®ÏÏ‰ÏƒÎ·</button>
          <button class="ghost" id="exportDrawXlsxBtn">â¬‡ï¸ Î•Î¾Î±Î³Ï‰Î³Î® ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚ (Excel)</button>
          <button class="ghost" id="toggleManualBtn" title="Î ÏÎ¿Ï‡Ï‰ÏÎ·Î¼Î­Î½ÎµÏ‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚">ğŸ› ï¸ Î§ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î· ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</button>
          <button class="ghost" id="clearDrawBtn">â†©ï¸ Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        </div>
      </div>
      <div id="pegTags" style="margin-top:6px"></div>
      <div class="table-wrap" id="drawTableWrap" style="margin-top:8px"></div>
      <div id="manualControls" style="display:none;margin-top:8px" class="small">
        <div class="row" style="gap:6px;flex-wrap:wrap">
          <button class="primary" id="manualSaveBtn">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î·Ï‚ ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚</button>
          <button class="ghost" id="manualCancelBtn">âœ–ï¸ Î†ÎºÏ…ÏÎ¿</button>
          <span class="muted">Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: ÎµÎ»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î¼Î¿Î½Î±Î´Î¹ÎºÏŒÏ„Î·Ï„Î± Î¸Î­ÏƒÎµÏ‰Î½ (1..N) & Î­Î³ÎºÏ…ÏÎ¿Ï…Ï‚ Ï„Î¿Î¼ÎµÎ¯Ï‚.</span>
        </div>
      </div>
      <div class="small muted" style="margin-top:6px">
        ÎšÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î±: Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ¿ÏÏ‚ Ï„Î¿Î¼ÎµÎ¯Ï‚. Î‘Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Î»Î±Ï€Î»Î¬ÏƒÎ¹Î¿ Ï„Î¿Ï… 5, Î¿ Î• ÎµÎ¯Î½Î±Î¹ Â«Ï„ÎµÏ‡Î½Î¹ÎºÏŒÏ‚Â» ÎºÎ±Î¹ Î´Î±Î½ÎµÎ¯Î¶ÎµÏ„Î±Î¹ Î¿Ï…ÏÎ±Î³Î¿ÏÏ‚ Ï„Î¿Ï… Î”
        Î¼ÏŒÎ½Î¿ Î³Î¹Î± Ï„Î·Î½ ÎµÏƒÏ‰Ï„ÎµÏÎ¹ÎºÎ® ÎºÎ±Ï„Î¬Ï„Î±Î¾Î· Ï„Î¿Ï… Î•.
      </div>
    </div>
  </section>

  <!-- ÎšÎ‘Î¤Î‘Î“Î¡Î‘Î¦Î— -->
  <section id="p-entry" class="page" style="display:none">
    <div class="card">
      <h2>ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î±Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½ (ÎµÎ½ÎµÏÎ³Î® Î·Î¼Î­ÏÎ±)</h2>
      <div class="table-wrap" id="resultsTableWrap"></div>
    </div>
  </section>

  <!-- Î’Î‘Î˜ÎœÎŸÎ›ÎŸÎ“Î™Î•Î£ -->
  <section id="p-scores" class="page" style="display:none">
    <div class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h2>Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯ÎµÏ‚</h2>
        <div class="row" style="flex:0">
          <button class="ghost" id="recalcBtn">ğŸ” Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button>
          <button class="primary" id="exportXlsxBtn">â¬‡ï¸ Î•Î¾Î±Î³Ï‰Î³Î® Excel</button>
        </div>
      </div>
      <div class="tabs" id="scoreTabs" style="margin-top:8px"></div>
      <div class="table-wrap" id="scoreTables"></div>
    </div>
  </section>

  <!-- Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ -->
  <section id="p-settings" class="page" style="display:none">
    <div class="card">
      <h2>Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</h2>
      <div class="row">
        <div><label>ÎŒÎ½Î¿Î¼Î± Î´Î¹Î¿ÏÎ³Î¬Î½Ï‰ÏƒÎ·Ï‚</label><input id="eventName" placeholder="Î .Ï‡. Î ÏÏ‰Ï„Î¬Î¸Î»Î·Î¼Î± 2025"></div>
        <div>
          <label>ÎšÎ±Î½ÏŒÎ½Î±Ï‚ Î¹ÏƒÎ¿Î²Î±Î¸Î¼Î¯Î±Ï‚ Î·Î¼Î­ÏÎ±Ï‚</label>
          <input value="Î’Î¬ÏÎ¿Ï‚ â†“ â†’ Î Î»Î®Î¸Î¿Ï‚ â†“ â†’ ÎœÎµÎ³. ÏˆÎ¬ÏÎ¹ â†“" disabled>
        </div>
      </div>
      <div class="small muted" style="margin-top:6px">
        Î—Î¼ÎµÏÎ®ÏƒÎ¹Î± Î±Ï„Î¿Î¼Î¹ÎºÎ®: Î¸Î­ÏƒÎ· <b>Î±Î½Î¬ Ï„Î¿Î¼Î­Î±</b>. Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Ï€ÏÏ‰Ï„Î¬Î¸Î»Î·Î¼Î± (Î±Ï„Î¿Î¼Î¹ÎºÏŒ): Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î±Ï…Ï„ÏÎ½ Ï„Ï‰Î½ Î¸Î­ÏƒÎµÏ‰Î½.
        ÎŸÎ¹ Î¸Î­ÏƒÎµÎ¹Ï‚ ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚ ÎºÎ±Ï„Î±Î½Î­Î¼Î¿Î½Ï„Î±Î¹ ÏƒÏ…Î½ÎµÏ‡ÏŒÎ¼ÎµÎ½Î± 1..N Ï‡Ï‰ÏÎ¯Ï‚ ÎºÎµÎ½Î¬, Î¼Îµ ÏƒÏ…Î½Î¿Ï‡Î® Î±Î½Î¬ Ï„Î¿Î¼Î­Î±.
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="ghost" id="saveStateBtn">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        <button class="ghost" id="loadStateBtn">ğŸ“‚ Î¦ÏŒÏÏ„Ï‰ÏƒÎ·</button>
        <button class="danger" id="resetBtn">ğŸ§¹ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
      </div>
    </div>
  </section>
</div>

<script>
/* ==== Helpers ==== */
(function(){ if (!String.prototype.replaceAll) { String.prototype.replaceAll = function(find, replace) { return this.split(find).join(replace); }; }})();
function safeEscapeHtml(s){ s = String(s == null ? "" : s); return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function safeSanitize(s){ s = String(s == null ? "" : s); return s.replace(/[^a-zA-Z0-9\-_. ]+/g,"").replace(/ /g,"_"); }
function getInitialPage(){ return (window.location && window.location.hash) ? window.location.hash.slice(1) : "p-participants"; }
if ("serviceWorker" in navigator) { navigator.serviceWorker.register("./service-worker.js").catch(function(){}); }
function $(id){ return document.getElementById(id); }
function uid(){ return Math.random().toString(36).slice(2,9); }
function shuffle(arr){ for(var i=arr.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=arr[i]; arr[i]=arr[j]; arr[j]=t; } return arr; }
function ceilDiv(a,b){ return Math.ceil(a/b); }

/* ==== State ==== */
var state = {
  settings: { eventName: "", sectors: ["A","B","C","D","E"] },
  athletes: [],
  days: [],
  activeDayId: null,
  teamRosters: {},         // club -> ids (Î­Ï‰Ï‚ 5)
  ui: { manualDraw: false } // Â«ÎºÏÏ…Ï†Î®Â» Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î· ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±
};
function save(){ localStorage.setItem("alieia_sector_positions_state", JSON.stringify(state)); }
function load(){ var raw=localStorage.getItem("alieia_sector_positions_state"); if(!raw) return false; var obj=JSON.parse(raw); for(var k in obj){ state[k]=obj[k]; } return true; }
function activeDay(){ for (var i=0;i<state.days.length;i++){ if(state.days[i].id===state.activeDayId) return state.days[i]; } return null; }

/* ==== Router ==== */
function showPage(pid){
  document.querySelectorAll(".page").forEach(function(p){ p.style.display=(p.id===pid?"block":"none"); });
  document.querySelectorAll("nav button").forEach(function(b){ b.classList.toggle("active", b.getAttribute("data-page")===pid); });
  renderAll(); location.hash = pid;
}
$("topNav").addEventListener("click", function(e){ if(e.target.tagName==="BUTTON"){ showPage(e.target.getAttribute("data-page")); } });
window.addEventListener("load", function(){ load(); if(state.days.length===0){ var id=uid(); state.days.push({id:id,name:"Î—Î¼Î­ÏÎ± 1",draw:{},results:{}}); state.activeDayId=id; } else if(!state.activeDayId){ state.activeDayId=state.days[0].id; } showPage(getInitialPage()); bindAll(); });

/* ==== Participants ==== */
function renderAthletes(){
  var wrap = $("athletesTableWrap");
  if(!wrap) return;
  if(state.athletes.length===0){ wrap.innerHTML = '<p class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ…Î¼Î¼ÎµÏ„Î­Ï‡Î¿Î½Ï„ÎµÏ‚ Î±ÎºÏŒÎ¼Î·.</p>'; return; }
  var html = '<table><thead><tr><th>#</th><th>Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½</th><th>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</th><th></th></tr></thead><tbody>';
  state.athletes.forEach(function(a,i){
    html += '<tr><td>'+ (i+1) +'</td><td>'+ safeEscapeHtml(a.name) +'</td><td>'+ safeEscapeHtml(a.club||"") +'</td>'
          + '<td><button class="danger" data-del="'+ a.id +'">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button></td></tr>';
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
  wrap.querySelectorAll("[data-del]").forEach(function(btn){
    btn.onclick=function(){
      var id=btn.getAttribute("data-del");
      state.athletes=state.athletes.filter(function(x){ return x.id!==id; });
      state.days.forEach(function(d){ if(d.draw) delete d.draw[id]; if(d.results) delete d.results[id]; });
      Object.keys(state.teamRosters).forEach(function(c){ state.teamRosters[c]=(state.teamRosters[c]||[]).filter(function(x){ return x!==id; }); });
      renderAll(); save();
    };
  });
}
function renderTeams(){
  var wrap = $("teamsWrap"); if(!wrap) return; wrap.innerHTML="";
  var byClub = new Map();
  state.athletes.forEach(function(a){ var c=(a.club||"-").trim(); if(!byClub.has(c)) byClub.set(c,[]); byClub.get(c).push(a); });
  byClub.forEach(function(arr){ arr.sort(function(a,b){ return a.name.localeCompare(b.name,'el'); }); });
  byClub.forEach(function(members,club){
    var box=document.createElement("div"); box.className="card";
    var chosen=new Set((state.teamRosters[club]||[]).slice(0,5));
    box.innerHTML = '<h3 style="margin:0 0 8px 0">'+ safeEscapeHtml(club) +' â€” ÎšÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î± <span class="muted small">('+ chosen.size +'/5)</span></h3>';
    members.forEach(function(m){
      var id='cb_'+club+'_'+m.id;
      var row=document.createElement("div"); row.className="row"; row.style.alignItems="center";
      var chk=document.createElement("input"); chk.type="checkbox"; chk.id=id; chk.checked=chosen.has(m.id); chk.style.width="auto";
      chk.onchange=function(){
        var list=new Set(state.teamRosters[club]||[]);
        if(chk.checked){ if(list.size>=5){ chk.checked=false; alert("ÎšÎ»ÎµÎ¹ÏƒÏ„Î® Ï€ÎµÎ½Ï„Î¬Î´Î±: Î¼Î­Ï‡ÏÎ¹ 5 Î¬Ï„Î¿Î¼Î±."); return; } list.add(m.id); }
        else list.delete(m.id);
        state.teamRosters[club]=Array.from(list); renderTeams(); save();
      };
      var lab=document.createElement("label"); lab.htmlFor=id; lab.textContent=m.name;
      row.appendChild(chk); row.appendChild(lab); box.appendChild(row);
    });
    wrap.appendChild(box);
  });
}

/* ==== Days & Draw ==== */
function renderDaysTabs(){
  var wrap = $("daysTabs"); if(!wrap) return; wrap.innerHTML="";
  if(state.days.length===0){ wrap.innerHTML = '<span class="muted small">ÎšÎ±Î¼Î¯Î± Î·Î¼Î­ÏÎ± Î±ÎºÏŒÎ¼Î·.</span>'; return; }
  state.days.forEach(function(d,i){
    var b=document.createElement("button"); b.className="pill"; b.textContent=(d.name||( "Î—Î¼Î­ÏÎ± "+(i+1)));
    if(d.id===state.activeDayId) b.style.borderColor="#22c55e";
    b.onclick=function(){ state.activeDayId=d.id; renderAll(); save(); };
    wrap.appendChild(b);
  });
}
function renderPegTags(){
  var wrap=$("pegTags"); if(!wrap) return; wrap.innerHTML="";
  var N=state.athletes.length;
  var d = activeDay();

  if(d && d.draw && Object.keys(d.draw).length){
    var counts = new Map(state.settings.sectors.map(function(s){return [s,0];}));
    Object.keys(d.draw).forEach(function(id){ var sec=d.draw[id].sector; counts.set(sec, (counts.get(sec)||0)+1); });
    var running=1;
    state.settings.sectors.forEach(function(sec){
      var c = counts.get(sec)||0;
      if(c>0){
        var start = running, end = running + c - 1;
        var span=document.createElement("span"); span.className="pill";
        span.textContent = sec + ': Î¸Î­ÏƒÎµÎ¹Ï‚ ' + start + 'â€“' + end;
        wrap.appendChild(span);
        running += c;
      }else{
        var span2=document.createElement("span"); span2.className="pill"; span2.textContent = sec + ': (ÎºÎ±Î½ÎµÎ¯Ï‚)'; wrap.appendChild(span2);
      }
    });
  } else {
    var per=ceilDiv(N,5);
    state.settings.sectors.forEach(function(sec,idx){
      var start = idx*per + 1;
      var end   = Math.min((idx+1)*per, N);
      var span=document.createElement("span"); span.className="pill";
      span.textContent = sec + ': ~' + start + 'â€“' + end + ' (ÎµÎ½Î´ÎµÎ¹ÎºÏ„Î¹ÎºÏŒ)';
      wrap.appendChild(span);
    });
  }
  var note=document.createElement("div"); note.className="small muted";
  note.textContent="ÎŸÎ¹ Î¸Î­ÏƒÎµÎ¹Ï‚ ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚ ÎºÎ±Ï„Î±Î½Î­Î¼Î¿Î½Ï„Î±Î¹ ÏƒÏ…Î½ÎµÏ‡ÏŒÎ¼ÎµÎ½Î± 1..N Ï‡Ï‰ÏÎ¯Ï‚ ÎºÎµÎ½Î¬, Î¼Îµ ÏƒÏ…Î½Î¿Ï‡Î® Î±Î½Î¬ Ï„Î¿Î¼Î­Î±. ÎšÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î± ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ¿ÏÏ‚ Ï„Î¿Î¼ÎµÎ¯Ï‚ ÏŒÏƒÎ¿ Î³Î¯Î½ÎµÏ„Î±Î¹.";
  wrap.appendChild(note);
}
function renderDraw(){
  var d=activeDay(); var wrap=$("drawTableWrap"); if(!wrap) return;
  var manualRowControls = state.ui.manualDraw;
  if(!d){ wrap.innerHTML='<p class="muted">Î•Ï€Î¯Î»ÎµÎ¾Îµ/Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î·Î¼Î­ÏÎ±.</p>'; $("manualControls").style.display="none"; return; }

  // Î”ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± Ï€Î¯Î½Î±ÎºÎ±
  var rows = state.athletes.map(function(a){ return {a:a, dd:d.draw[a.id]}; }).sort(function(x,y){
    var xs=x.dd?x.dd.sector:""; var ys=y.dd?y.dd.sector:"";
    if(xs===ys){ var xp=x.dd?x.dd.peg:999999; var yp=y.dd?y.dd.peg:999999; return xp-yp;} return xs.localeCompare(ys);
  });

  // Header
  var html = '<div class="small muted">'+ safeEscapeHtml(state.settings.eventName||"") +' â€” '+ safeEscapeHtml(d?d.name:"") +'</div>';
  html += '<table><thead><tr>'
       + '<th>#</th><th>Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½</th><th>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</th>'
       + (manualRowControls? '<th>Î¤Î¿Î¼Î­Î±Ï‚ (edit)</th><th>Î˜Î­ÏƒÎ· (edit)</th>' : '<th>Î¤Î¿Î¼Î­Î±Ï‚</th><th>Î˜Î­ÏƒÎ·</th>')
       + '</tr></thead><tbody>';

  var sectorOpts = state.settings.sectors.map(function(s){return '<option value="'+s+'">'+s+'</option>';}).join("");

  rows.forEach(function(r,i){
    var sec = r.dd? r.dd.sector : "";
    var peg = r.dd? r.dd.peg : "";
    if(manualRowControls){
      html += '<tr>'
        + '<td>'+(i+1)+'</td>'
        + '<td>'+ safeEscapeHtml(r.a.name) +'</td>'
        + '<td>'+ safeEscapeHtml(r.a.club||"") +'</td>'
        + '<td><select class="manual-sec" data-id="'+r.a.id+'">'+ sectorOpts.replace('value="'+sec+'"','value="'+sec+'" selected') +'</select></td>'
        + '<td><input class="manual-peg" data-id="'+r.a.id+'" type="number" min="1" step="1" value="'+ (peg||"") +'" placeholder="1..'+state.athletes.length+'"></td>'
        + '</tr>';
    } else {
      html += '<tr>'
        + '<td>'+(i+1)+'</td>'
        + '<td>'+ safeEscapeHtml(r.a.name) +'</td>'
        + '<td>'+ safeEscapeHtml(r.a.club||"") +'</td>'
        + '<td>'+ (sec||"-") +'</td>'
        + '<td>'+ (peg||"-") +'</td>'
        + '</tr>';
    }
  });
  html += '</tbody></table>';
  wrap.innerHTML=html;

  // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ·/Î±Ï€ÏŒÎºÏÏ…ÏˆÎ· control bar
  $("manualControls").style.display = manualRowControls ? "block" : "none";
}

/* ==== Entry ==== */
function renderResults(){
  var d=activeDay(); var wrap=$("resultsTableWrap"); if(!wrap) return;
  if(!d){ wrap.innerHTML='<p class="muted">Î•Ï€Î¯Î»ÎµÎ¾Îµ/Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î·Î¼Î­ÏÎ±.</p>'; return; }
  var rows = state.athletes.map(function(a){ return {a:a, dd: (d.draw ? d.draw[a.id] : undefined)}; });
  rows.sort(function(x,y){
    var xs=x.dd?x.dd.sector:""; var ys=y.dd?y.dd.sector:"";
    if(xs===ys){ var xp=x.dd?x.dd.peg:999999; var yp=y.dd?y.dd.peg:999999; return xp-yp;} return xs.localeCompare(ys);
  });

  var html = '<table><thead><tr>'
    + '<th>#</th><th>Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½</th><th>Î£ÏÎ»Î»Î¿Î³Î¿Ï‚</th><th>Î¤Î¿Î¼Î­Î±Ï‚</th><th>Î˜Î­ÏƒÎ·</th>'
    + '<th>Î’Î¬ÏÎ¿Ï‚ (g)</th><th>Î Î»Î®Î¸Î¿Ï‚</th><th>ÎœÎµÎ³. ÏˆÎ¬ÏÎ¹ (g)</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>'
    + '</tr></thead><tbody>';

  rows.forEach(function(r,i){
    var res = (d.results && d.results[r.a.id]) ? d.results[r.a.id] : {weight:0,biggest:0,count:0,status:"OK"};
    html += '<tr>'
      + '<td>'+ (i+1) +'</td><td>'+ safeEscapeHtml(r.a.name) +'</td><td>'+ safeEscapeHtml(r.a.club||"") +'</td>'
      + '<td>'+ (r.dd? r.dd.sector:"-") +'</td><td>'+ (r.dd? r.dd.peg:"-") +'</td>'
      + '<td><input type="number" min="0" data-id="'+ r.a.id +'" data-f="weight" value="'+ (res.weight||0) +'"></td>'
      + '<td><input type="number" min="0" data-id="'+ r.a.id +'" data-f="count" value="'+ (res.count||0) +'"></td>'
      + '<td><input type="number" min="0" data-id="'+ r.a.id +'" data-f="biggest" value="'+ (res.biggest||0) +'"></td>'
      + '<td><select data-id="'+ r.a.id +'" data-f="status">'
        + '<option value="OK" '+ (res.status==="OK"?"selected":"") +'>OK</option>'
        + '<option value="DQ" '+ (res.status==="DQ"?"selected":"") +'>DQ</option>'
        + '<option value="NS" '+ (res.status==="NS"?"selected":"") +'>NS</option>'
      + '</select></td>'
    + '</tr>';
  });
  html += '</tbody></table>';
  wrap.innerHTML=html;

  wrap.querySelectorAll("input,select").forEach(function(el){
    el.oninput=function(){
      var id=el.getAttribute("data-id"), f=el.getAttribute("data-f"); var d2=activeDay(); if(!d2) return;
      if(!d2.results) d2.results={};
      if(!d2.results[id]) d2.results[id]={weight:0,biggest:0,count:0,status:"OK"};
      var v=el.value; if(f==="weight"||f==="biggest"||f==="count") v=Number(v||0);
      d2.results[id][f]=v; save();
    };
  });
}

/* ==== Buttons & Settings ==== */
function bindAll(){
  // Common
  var b1=$("saveStateBtn"), b2=$("loadStateBtn"), b3=$("resetBtn");
  if(b1){ b1.onclick=function(){ save(); alert("Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿Î½ browser."); }; }
  if(b2){ b2.onclick=function(){ if(!load()) alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±."); renderAll(); }; }
  if(b3){ b3.onclick=function(){ if(confirm("Î£Î¯Î³Î¿Ï…ÏÎ±; Î˜Î± Ï‡Î±Î¸Î¿ÏÎ½ ÏŒÎ»Î±.")){ localStorage.removeItem("alieia_sector_positions_state"); location.reload(); } }; }

  // Participants
  var add=$("addAthleteBtn"), bulk=$("addBulkBtn"), excelBtn=$("excelBtn"), excelInp=$("excelInput");
  if(add){ add.onclick=function(){ var nm=$("athleteName").value.trim(); if(!nm) return; var club=$("club").value.trim(); state.athletes.push({id:uid(),name:nm,club:club}); $("athleteName").value=""; $("club").value=""; renderAll(); save(); }; }
  if(bulk){ bulk.onclick=function(){ var txt=prompt("Î•Ï€Î¹ÎºÏŒÎ»Î»Î·ÏƒÎµ Î»Î¯ÏƒÏ„Î± (ÎŒÎ½Î¿Î¼Î±[, Î£ÏÎ»Î»Î¿Î³Î¿Ï‚]) â€” Î¼Î¯Î± Î±Î½Î¬ Î³ÏÎ±Î¼Î¼Î®",""); if(!txt) return; txt.split("\n").map(function(x){return x.trim();}).filter(Boolean).forEach(function(line){ var parts=line.split(","); var name=parts[0]||""; var club=(parts[1]||""); state.athletes.push({id:uid(),name:name.trim(),club:club.trim()}); }); renderAll(); save(); }; }
  if(excelBtn && excelInp){ excelBtn.onclick=function(){ excelInp.click(); }; excelInp.onchange=excelImport; }

  // Days
  var addDay=$("addDayBtn"); if(addDay){ addDay.onclick=function(){ var id=uid(); var idx=state.days.length+1; state.days.push({id:id,name:"Î—Î¼Î­ÏÎ± "+idx,draw:{},results:{}}); state.activeDayId=id; renderAll(); save(); }; }

  // Draw buttons
  var dBtn=$("drawBtn"), clrBtn=$("clearDrawBtn"), xlsBtn=$("exportDrawXlsxBtn"), tgl=$("toggleManualBtn");
  if(dBtn){ dBtn.onclick=function(){ var d=activeDay(); if(!d){ alert("Î•Ï€Î¯Î»ÎµÎ¾Îµ/Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Î·Î¼Î­ÏÎ±."); return; } doDrawForDay(d); renderPegTags(); renderDraw(); renderResults(); renderScores(); save(); }; }
  if(clrBtn){ clrBtn.onclick=function(){ var d=activeDay(); if(!d) return; d.draw={}; renderPegTags(); renderDraw(); renderResults(); renderScores(); save(); }; }
  if(xlsBtn){ xlsBtn.onclick=function(){ exportDrawXLSX(); }; }
  if(tgl){ tgl.onclick=function(){ state.ui.manualDraw = !state.ui.manualDraw; renderDraw(); }; }
  var msave=$("manualSaveBtn"), mcancel=$("manualCancelBtn");
  if(msave){ msave.onclick=manualSave; }
  if(mcancel){ mcancel.onclick=function(){ state.ui.manualDraw=false; renderDraw(); }; }

  // Scores
  var recalc=$("recalcBtn"), xlsx=$("exportXlsxBtn");
  if(recalc){ recalc.onclick=function(){ renderScores(); }; }
  if(xlsx){ xlsx.onclick=function(){ exportXLSX(); }; }

  // Settings
  var ev=$("eventName"); if(ev){ ev.oninput=function(e){ state.settings.eventName=e.target.value; save(); }; }
}

/* ==== Scoring ==== */
function sectorOrder(){ return state.settings.sectors; }
function scoreDay(dayId){
  var d = state.days.find(function(x){ return x.id===dayId; }); if(!d) return {ordered:[], placeMap:new Map(), sectorMaxMap:new Map()};
  var N = state.athletes.length, per = ceilDiv(N,5);
  var bySec = new Map(); sectorOrder().forEach(function(s){ bySec.set(s,[]); });
  state.athletes.forEach(function(a){
    var dd=d.draw[a.id]; var r=(d.results && d.results[a.id]) || {weight:0,biggest:0,count:0,status:"OK"};
    if(!dd || r.status!=="OK") return;
    bySec.get(dd.sector).push({id:a.id,name:a.name,club:a.club,sector:dd.sector,peg:dd.peg,weight:r.weight||0,biggest:r.biggest||0,count:r.count||0});
  });
  var E = bySec.get("E"), D = bySec.get("D");
  if(E && D && E.length < per){
    var need = per - E.length;
    var donors = D.slice().sort(function(a,b){return a.peg-b.peg;}).slice(-need).map(function(x){ var y={}; for(var k in x){ y[k]=x[k]; } y.borrowedFrom="D"; return y; });
    Array.prototype.push.apply(E, donors);
  }
  var placeMap = new Map();
  var sectorMaxMap = new Map();
  sectorOrder().forEach(function(sec){
    var arr = bySec.get(sec);
    arr.sort(function(a,b){ return (b.weight-a.weight) || (b.count-a.count) || (b.biggest-a.biggest) || a.id.localeCompare(b.id); });
    sectorMaxMap.set(sec, Math.max(arr.length, per));
    var place=1;
    arr.forEach(function(row){
      if(sec!=="E" || !row.borrowedFrom){ placeMap.set(row.id, {sec:sec, place:place}); }
      place++;
    });
  });
  var ordered = [];
  sectorOrder().forEach(function(sec){
    (bySec.get(sec)||[]).forEach(function(r){
      var pl = placeMap.get(r.id);
      ordered.push(Object.assign({}, r, { place: (pl && pl.sec===sec)? pl.place : (r.borrowedFrom? "(Î´Î±Î½.)" : null)}));
    });
  });
  return {ordered:ordered, placeMap:placeMap, sectorMaxMap:sectorMaxMap};
}
function scoreAggregate(){
  var acc=new Map(); state.athletes.forEach(function(a){ acc.set(a.id,{id:a.id,name:a.name,club:a.club, total_place:0, days:0, total_weight:0, total_count:0, best_biggest:0}); });
  state.days.forEach(function(d){
    var sc = scoreDay(d.id);
    state.athletes.forEach(function(a){
      var dd = d.draw[a.id]; var sec = dd? dd.sector : null;
      var r = d.results ? d.results[a.id] : null;
      var secMax = sec? (sc.sectorMaxMap.get(sec)||0) : 0;
      var entry = acc.get(a.id);
      var pl = sc.placeMap.get(a.id);
      var place = (pl && pl.sec===sec)? pl.place : (secMax>0? (secMax+1) : 0);
      if(sec){ entry.total_place += place; entry.days += 1; }
      if(r && r.status==="OK"){ entry.total_weight += (r.weight||0); entry.total_count += (r.count||0); entry.best_biggest = Math.max(entry.best_biggest, (r.biggest||0)); }
    });
  });
  var rows=Array.from(acc.values());
  rows.sort(function(a,b){ return (a.total_place-b.total_place) || (b.total_weight-a.total_weight) || (b.total_count-a.total_count) || (b.best_biggest-a.best_biggest) || a.name.localeCompare(b.name,'el'); });
  return rows;
}
function getClubs(){ return Array.from(new Set(state.athletes.map(function(a){return (a.club||"-").trim();}))); }
function teamRoster(club){ return (state.teamRosters[club]||[]).filter(function(id){ return state.athletes.find(function(a){return a.id===id;}); }).slice(0,5); }
function teamScoreDay(dayId){
  var d = state.days.find(function(x){return x.id===dayId;}); if(!d) return [];
  var sc = scoreDay(dayId);
  var teams=[];
  getClubs().forEach(function(club){
    var roster = teamRoster(club); if(roster.length===0) return;
    var sum=0, w=0; var names=[];
    roster.forEach(function(id){
      var a=state.athletes.find(function(x){return x.id===id;}); names.push(a? a.name:"â€”");
      var dd=d.draw[id]; var sec=dd? dd.sector:null;
      var secMax = sec? (sc.sectorMaxMap.get(sec)||0) : 0;
      var pl = sc.placeMap.get(id);
      var place = (pl && pl.sec===sec)? pl.place : (secMax+1);
      sum += place;
      var rr=d.results ? d.results[id] : null; if(rr && rr.status==="OK") w += (rr.weight||0);
    });
    teams.push({club:club, team_place_sum:sum, team_weight:w, members:names});
  });
  teams.sort(function(a,b){ return (a.team_place_sum-b.team_place_sum) || (b.team_weight-a.team_weight) || a.club.localeCompare(b.club,'el'); });
  return teams;
}
function teamScoreAggregate(){
  var validClubs = getClubs().filter(function(c){ return teamRoster(c).length === 5; });
  var acc=new Map(); validClubs.forEach(function(c){ acc.set(c,{club:c, place_sum:0, weight_sum:0, days:0}); });
  state.days.forEach(function(d){
    var t = teamScoreDay(d.id);
    var byClub=new Map(t.map(function(x){return [x.club,x];}));
    acc.forEach(function(v,c){
      var x=byClub.get(c);
      if(x){ v.place_sum+=x.team_place_sum; v.weight_sum+=x.team_weight; v.days+=1; }
    });
  });
  var rows=Array.from(acc.values());
  rows.sort(function(a,b){ return (a.place_sum-b.place_sum) || (b.weight_sum-a.weight_sum) || a.club.localeCompare(b.club,'el'); });
  return rows;
}

/* ==== Draw logic (auto) ==== */
function doDrawForDay(d){
  var sectors = state.settings.sectors; // ["A","B","C","D","E"]
  var N = state.athletes.length;
  var capAD = Math.ceil(N/5), capE  = Math.floor(N/5);
  var capacity = new Map([["A", capAD], ["B", capAD], ["C", capAD], ["D", capAD], ["E", capE]]);
  var buckets = new Map(sectors.map(function(s){ return [s, []]; }));
  var clubInSector = new Map(sectors.map(function(s){ return [s, new Set()]; }));
  var fillCount = new Map(sectors.map(function(s){ return [s,0]; }));

  function hasRoom(sec){ return fillCount.get(sec) < capacity.get(sec); }
  function placeIn(sec, a){
    if(!hasRoom(sec)) return false;
    buckets.get(sec).push(a.id);
    fillCount.set(sec, fillCount.get(sec)+1);
    clubInSector.get(sec).add((a.club||"-").trim());
    return true;
  }

  var rosterSet = new Set();
  Object.values(state.teamRosters).forEach(function(arr){ (arr||[]).slice(0,5).forEach(function(id){ rosterSet.add(id); }); });
  var rosterAthletes = state.athletes.filter(function(a){ return rosterSet.has(a.id); });
  var otherAthletes  = state.athletes.filter(function(a){ return !rosterSet.has(a.id); });
  shuffle(rosterAthletes); shuffle(otherAthletes);

  var violations=0;
  rosterAthletes.forEach(function(a){
    var c=(a.club||"-").trim();
    var choices = sectors.filter(function(s){ return hasRoom(s) && !clubInSector.get(s).has(c); });
    var fallback = sectors.filter(function(s){ return hasRoom(s); });
    var pickFrom = choices.length? choices : fallback;
    if(pickFrom.length===0){ violations++; return; }
    var sec = pickFrom.slice().sort(function(s1,s2){ return fillCount.get(s1)-fillCount.get(s2); })[0];
    if(!choices.length) violations++;
    placeIn(sec, a);
  });
  otherAthletes.forEach(function(a){
    var c=(a.club||"-").trim();
    var preferred = sectors.filter(function(s){ return hasRoom(s) && !clubInSector.get(s).has(c); });
    var pickFrom = preferred.length? preferred : sectors.filter(function(s){ return hasRoom(s); });
    if(pickFrom.length===0) return;
    var sec = pickFrom.slice().sort(function(s1,s2){ return fillCount.get(s1)-fillCount.get(s2); })[0];
    placeIn(sec, a);
  });

  d.draw = {};
  var start=1;
  sectors.forEach(function(sec){
    var list=buckets.get(sec)||[];
    var cnt=list.length;
    var localPegs = []; for(var k=0;k<cnt;k++) localPegs.push(start + k);
    shuffle(localPegs);
    list.forEach(function(athId,i){
      d.draw[athId] = { sector:sec, peg: localPegs[i] };
    });
    start += cnt;
  });

  if(violations>0){ alert("Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·: Î´ÎµÎ½ Ï„Î·ÏÎ®Î¸Î·ÎºÎ±Î½ Ï€Î»Î®ÏÏ‰Ï‚ ÏŒÎ»Î¿Î¹ Î¿Î¹ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î¿Î¯ ÏƒÎµ "+violations+" Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ·/ÎµÎ¹Ï‚."); }
}

/* ==== Export ==== */
function excelImport(ev){
  var file=ev.target.files[0]; if(!file) return;
  var name=file.name.toLowerCase(); var reader=new FileReader();
  if(name.endsWith(".csv")){
    reader.onload=function(){
      var lines=reader.result.split(/\r?\n/).map(function(x){return x.trim();}).filter(Boolean);
      lines.forEach(function(line){ var parts=line.split(","); var nm=parts[0]; var club=parts[1]||""; if(nm) state.athletes.push({id:uid(),name:nm.trim(),club:club.trim()}); });
      renderAll(); save(); ev.target.value="";
    }; reader.readAsText(file,"utf-8");
  } else {
    reader.onload=function(e){
      var data=new Uint8Array(e.target.result); var wb=XLSX.read(data,{type:"array"});
      var ws=wb.Sheets[wb.SheetNames[0]]; var arr=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
      arr.forEach(function(row,idx){ if(idx===0 && String(row[0]).toLowerCase().indexOf("Î¿Î½Î¿Î¼Î±")>-1) return;
        var nm=String(row[0]||"").trim(); if(!nm) return; var club=String(row[1]||"").trim();
        state.athletes.push({id:uid(), name:nm, club:club});
      });
      renderAll(); save(); ev.target.value="";
    }; reader.readAsArrayBuffer(file);
  }
}
function exportDrawXLSX(){
  var d=activeDay(); if(!d || !d.draw || Object.keys(d.draw).length===0){ alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î³Î¹Î± ÎµÎ¾Î±Î³Ï‰Î³Î®."); return; }
  var rows = state.athletes
    .map(function(a){ var dd=d.draw[a.id]||{}; return { "Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½": a.name, "Î£ÏÎ»Î»Î¿Î³Î¿Ï‚": a.club||"", "Î¤Î¿Î¼Î­Î±Ï‚": dd.sector||"", "Î˜Î­ÏƒÎ·": dd.peg||"" }; })
    .sort(function(x,y){ return (x["Î¤Î¿Î¼Î­Î±Ï‚"]||"").localeCompare(y["Î¤Î¿Î¼Î­Î±Ï‚"]||"") || ((x["Î˜Î­ÏƒÎ·"]||999999) - (y["Î˜Î­ÏƒÎ·"]||999999)); });

  var wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), "ÎšÎ»Î®ÏÏ‰ÏƒÎ·");
  var dname = (activeDay()||{}).name || "Î—Î¼Î­ÏÎ±";
  var title = (state.settings.eventName||"ÎšÎ»Î®ÏÏ‰ÏƒÎ·") + "_" + safeSanitize(dname);
  XLSX.writeFile(wb, "Klirosi-"+safeSanitize(title)+".xlsx");
}
function exportXLSX(){
  var wb = XLSX.utils.book_new();

  var agg = scoreAggregate().map(function(r,i){
    return { "#": i+1, "ÎŒÎ½Î¿Î¼Î±": r.name, "Î£ÏÎ»Î»Î¿Î³Î¿Ï‚": r.club||"", "Î—Î¼Î­ÏÎµÏ‚": r.days,
             "Î£ÏÎ½Î¿Î»Î¿ Î˜Î­ÏƒÎµÏ‰Î½": r.total_place, "Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚": r.total_weight,
             "Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î Î»Î®Î¸Î¿Ï‚": r.total_count, "ÎšÎ±Î». ÎœÎµÎ³.Î¨Î¬ÏÎ¹": r.best_biggest };
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(agg), "Î‘Ï„Î¿Î¼Î¹ÎºÏŒ-Î£ÏÎ½Î¿Î»Î¿");

  var teamsAgg = teamScoreAggregate().map(function(t,i){
    return { "#": i+1, "Î£ÏÎ»Î»Î¿Î³Î¿Ï‚": t.club, "Î£ÏÎ½Î¿Î»Î¿ Î˜Î­ÏƒÎµÏ‰Î½": t.place_sum,
             "Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚": t.weight_sum, "Î—Î¼Î­ÏÎµÏ‚": t.days };
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(teamsAgg), "ÎŸÎ¼Î±Î´Î¹ÎºÏŒ-Î£ÏÎ½Î¿Î»Î¿");

  state.days.forEach(function(d){
    var day = scoreDay(d.id);
    var dayRows = day.ordered
      .filter(function(r){ return typeof r.place === "number"; })
      .sort(function(a,b){
        return (a.place - b.place) || a.sector.localeCompare(b.sector) ||
               (b.weight - a.weight) || (b.count - a.count) ||
               (b.biggest - a.biggest) || a.name.localeCompare(b.name,'el');
      })
      .map(function(r,i){
        return { "#": i+1, "Î˜Î­ÏƒÎ· Î¤Î¿Î¼Î­Î±": r.place, "Î¤Î¿Î¼Î­Î±Ï‚": r.sector, "ÎŒÎ½Î¿Î¼Î±": r.name,
                 "Î£ÏÎ»Î»Î¿Î³Î¿Ï‚": r.club||"", "Î’Î¬ÏÎ¿Ï‚(g)": r.weight, "Î Î»Î®Î¸Î¿Ï‚": r.count,
                 "ÎœÎµÎ³.Î¨Î¬ÏÎ¹(g)": r.biggest, "Î˜Î­ÏƒÎ·": r.peg };
      });

    XLSX.utils.book_append_sheet(
      wb,
      XLSX.utils.json_to_sheet(dayRows),
      ("Î—Î¼Î­ÏÎ±-"+safeSanitize(d.name||""))
    );

    var tRows = teamScoreDay(d.id).map(function(t,i){
      return { "#": i+1, "Î£ÏÎ»Î»Î¿Î³Î¿Ï‚": t.club, "5Î¬Î´Î±": t.members.join(", "),
               "Î†Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î˜Î­ÏƒÎµÏ‰Î½": t.team_place_sum, "Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚": t.team_weight };
    });
    XLSX.utils.book_append_sheet(
      wb,
      XLSX.utils.json_to_sheet(tRows),
      ("ÎŸÎ¼Î±Î´Î¹ÎºÏŒ-"+safeSanitize(d.name||""))
    );
  });

  var title = state.settings.eventName || "Î‘Î³ÏÎ½Î±Ï‚_Î‘Î»Î¹ÎµÎ¯Î±Ï‚";
  XLSX.writeFile(wb, "Exagogi-"+safeSanitize(title)+".xlsx");
}

/* ==== Manual Draw Save ==== */
function manualSave(){
  var d = activeDay(); if(!d){ alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³Î® Î·Î¼Î­ÏÎ±."); return; }
  var secEls = Array.from(document.querySelectorAll("#drawTableWrap .manual-sec"));
  var pegEls = Array.from(document.querySelectorAll("#drawTableWrap .manual-peg"));
  if(secEls.length===0 || pegEls.length===0){ alert("Î”ÎµÎ½ ÎµÎ¯ÏƒÏ„Îµ ÏƒÎµ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î·Ï‚ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚."); return; }

  var N = state.athletes.length;
  var draw = {}; var used = new Set(); var errors=[];
  var secMap = new Map(); state.settings.sectors.forEach(function(s){ secMap.set(s,true); });

  secEls.forEach(function(sel,i){
    var id = sel.getAttribute("data-id");
    var sec = (sel.value||"").trim();
    var peg = Number((pegEls[i].value||"").trim());
    if(!secMap.has(sec)) errors.push("ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿Ï‚ Ï„Î¿Î¼Î­Î±Ï‚ Î³Î¹Î± Î±Î¸Î»Î·Ï„Î® #"+(i+1));
    if(!Number.isInteger(peg) || peg<1 || peg>N) errors.push("ÎœÎ· Î­Î³ÎºÏ…ÏÎ· Î¸Î­ÏƒÎ· (1.."+N+") Î³Î¹Î± Î±Î¸Î»Î·Ï„Î® #"+(i+1));
    if(used.has(peg)) errors.push("Î”Î¹Ï€Î»Î® Î¸Î­ÏƒÎ·: "+peg);
    used.add(peg);
    draw[id] = { sector: sec, peg: peg };
  });

  if(errors.length){
    alert("Î”ÎµÎ½ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ. Î’ÏÎ­Î¸Î·ÎºÎ±Î½ Ï€ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î±:\n- " + errors.join("\n- "));
    return;
  }

  d.draw = draw;
  state.ui.manualDraw = false;
  save();
  renderPegTags(); renderDraw(); renderResults(); renderScores();
  alert("Î— Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î· ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.");
}

/* ==== Scores UI ==== */
function tab(label,cb){ var b=document.createElement("button"); b.className="pill"; b.textContent=label; b.onclick=cb; return b; }
function makeTable(rows,title,headers){
  var html = '<h3 style="margin:6px 0">'+ safeEscapeHtml(title) +'</h3><table><thead><tr>'+ headers.map(function(h){return '<th>'+ safeEscapeHtml(h) +'</th>';}).join("") +'</tr></thead><tbody>';
  rows.forEach(function(r){ html += '<tr>'+ r.map(function(c){return '<td>'+ safeEscapeHtml(String(c)) +'</td>';}).join("") +'</tr>'; });
  html += '</tbody></table>'; return html;
}
function renderScores(){
  var tabs=$("scoreTabs"), area=$("scoreTables"); if(!tabs || !area) return; tabs.innerHTML=""; area.innerHTML="";
  var d=activeDay();
  if(d){
    var btnDay = tab('Î—Î¼Î­ÏÎ±: '+d.name+' â€” Î‘Ï„Î¿Î¼Î¹ÎºÏŒ (1Î¿Î¹ â†’ 2Î¿Î¹ â†’ ...)', function(){
      var day = scoreDay(d.id);
      var rowsSorted = day.ordered
        .filter(function(r){ return typeof r.place === "number"; })
        .sort(function(a,b){
          return (a.place - b.place) || a.sector.localeCompare(b.sector) ||
                 (b.weight - a.weight) || (b.count - a.count) ||
                 (b.biggest - a.biggest) || a.name.localeCompare(b.name,'el');
        });
      var rs = rowsSorted.map(function(r,i){ return [i+1, r.place, r.sector, r.name, r.club||"", r.weight, r.count, r.biggest, r.peg]; });
      area.innerHTML = makeTable(rs,'ÎšÎ±Ï„Î¬Ï„Î±Î¾Î· Î—Î¼Î­ÏÎ±Ï‚ (ÏŒÎ»Î¿Î¹ Î¿Î¹ 1Î¿Î¹ â†’ 2Î¿Î¹ â†’ 3Î¿Î¹ â€¦) â€” (tie-break: Î’Î¬ÏÎ¿Ï‚ â†’ Î Î»Î®Î¸Î¿Ï‚ â†’ ÎœÎµÎ³. ÏˆÎ¬ÏÎ¹)',["#","Î˜Î­ÏƒÎ· Î¤Î¿Î¼Î­Î±","Î¤Î¿Î¼Î­Î±Ï‚","Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î’Î¬ÏÎ¿Ï‚(g)","Î Î»Î®Î¸Î¿Ï‚","ÎœÎµÎ³.Î¨Î¬ÏÎ¹(g)","Î˜Î­ÏƒÎ·"]);
    }); tabs.appendChild(btnDay); btnDay.click();
  }
  var btnAgg = tab("Î£ÏÎ½Î¿Î»Î¿ Î ÏÏ‰Ï„Î±Î¸Î»Î®Î¼Î±Ï„Î¿Ï‚ (Î‘Ï„Î¿Î¼Î¹ÎºÏŒ â€” Î±Ï€ÏŒ Î¸Î­ÏƒÎµÎ¹Ï‚ Ï„Î¿Î¼Î­Î±)", function(){
    var rows = scoreAggregate().map(function(r,i){ return [i+1,r.name,r.club||"",r.days,r.total_place,r.total_weight,r.total_count,r.best_biggest]; });
    area.innerHTML = makeTable(rows,"Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î‘Ï„Î¿Î¼Î¹ÎºÎ® ÎšÎ±Ï„Î¬Ï„Î±Î¾Î· (Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¸Î­ÏƒÎµÏ‰Î½ Ï„Î¿Î¼Î­Î± Î±Î½Î¬ Î·Î¼Î­ÏÎ±)",["#","Î£Ï…Î¼Î¼ÎµÏ„Î­Ï‡Ï‰Î½","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î—Î¼Î­ÏÎµÏ‚","Î£ÏÎ½Î¿Î»Î¿ Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½. Î’Î¬ÏÎ¿Ï‚","Î£Ï…Î½. Î Î»Î®Î¸Î¿Ï‚","ÎšÎ±Î». ÎœÎµÎ³.Î¨Î¬ÏÎ¹"]);
  }); tabs.appendChild(btnAgg);
  if(d){
    var btnTeamDay = tab('Î—Î¼Î­ÏÎ±: '+d.name+' â€” ÎŸÎ¼Î±Î´Î¹ÎºÏŒ 5Î¬Î´Î±Ï‚', function(){
      var rows = teamScoreDay(d.id).map(function(t,i){ return [i+1,t.club,t.members.join(", "),t.team_place_sum,t.team_weight]; });
      area.innerHTML = makeTable(rows,'ÎŸÎ¼Î±Î´Î¹ÎºÏŒ Î—Î¼Î­ÏÎ±Ï‚ (ÎºÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î± â€” Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¸Î­ÏƒÎµÏ‰Î½ Ï„Î¿Î¼Î­Î±)',["#","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","5Î¬Î´Î±","Î†Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚"]);
    }); tabs.appendChild(btnTeamDay);
  }
  var btnTeamAgg = tab("Î£ÏÎ½Î¿Î»Î¿ Î ÏÏ‰Ï„Î±Î¸Î»Î®Î¼Î±Ï„Î¿Ï‚ (ÎŸÎ¼Î±Î´Î¹ÎºÏŒ 5Î¬Î´Î±Ï‚)", function(){
    var rows = teamScoreAggregate().map(function(t,i){ return [i+1,t.club,t.place_sum,t.weight_sum,t.days]; });
    area.innerHTML = makeTable(rows,"ÎŸÎ¼Î±Î´Î¹ÎºÏŒ Î ÏÏ‰Ï„Î±Î¸Î»Î®Î¼Î±Ï„Î¿Ï‚ (Î¼ÏŒÎ½Î¿ ÏƒÏÎ»Î»Î¿Î³Î¿Î¹ Î¼Îµ ÎºÎ»ÎµÎ¹ÏƒÏ„Î® 5Î¬Î´Î±)",["#","Î£ÏÎ»Î»Î¿Î³Î¿Ï‚","Î£ÏÎ½Î¿Î»Î¿ Î˜Î­ÏƒÎµÏ‰Î½","Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î’Î¬ÏÎ¿Ï‚","Î—Î¼Î­ÏÎµÏ‚"]);
  }); tabs.appendChild(btnTeamAgg);
}

/* ==== Render all ==== */
function renderAll(){
  var ev=$("eventName"); if(ev) ev.value = state.settings.eventName||"";
  renderAthletes();
  renderTeams();
  renderDaysTabs();
  renderPegTags();
  renderDraw();
  renderResults();
  renderScores();
}
</script>
</body>
</html>